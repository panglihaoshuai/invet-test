# 🔍 调试指南 - 请查看浏览器控制台

## 重要更新

### ✅ 已完成的修复

1. **邮件发送逻辑更新**
   - ✅ 只有 `1062250152@qq.com` 会尝试发送真实邮件
   - ✅ 其他所有邮箱都使用开发模式（显示验证码弹窗）
   - ✅ 即使管理员邮箱发送失败，也会显示验证码弹窗

2. **详细日志添加**
   - ✅ 礼品码生成添加详细日志
   - ✅ 支付系统切换添加详细日志
   - ✅ 所有错误都会显示详细信息

---

## 🚨 立即操作：测试并查看控制台

### 步骤 1: 打开浏览器控制台

1. 按 **F12** 键（或右键点击页面 → 检查）
2. 切换到 **Console** 标签
3. 保持控制台打开

### 步骤 2: 测试礼品码生成

1. 使用管理员账号登录（1062250152@qq.com）
2. 进入管理员后台
3. 点击"礼品码管理"标签
4. 点击"生成礼品码"按钮
5. **立即查看控制台输出**

#### 预期看到的日志：

```javascript
🎁 generateGiftCode: 开始生成 {user_id: "...", maxRedemptions: 1, expiresInDays: 30}
✅ generateGiftCode: 生成随机码 "A3K7N9P2"
🎁 generateGiftCode: 插入数据库 {code: "A3K7N9P2", max_redemptions: 1, ...}
✅ generateGiftCode: 成功 {id: "...", code: "A3K7N9P2", ...}
```

#### 如果失败，会看到：

```javascript
❌ generateGiftCode: 未找到用户
// 或
❌ generateGiftCode: RPC 生成码失败 {message: "...", details: "...", hint: "...", code: "..."}
// 或
❌ generateGiftCode: 插入失败 {message: "...", details: "...", hint: "...", code: "..."}
```

### 步骤 3: 测试支付系统切换

1. 在管理员后台
2. 找到"支付系统"开关
3. 点击切换
4. **立即查看控制台输出**

#### 预期看到的日志：

```javascript
🔧 togglePaymentSystem: 调用 RPC {enabled: true, user_id: "..."}
✅ togglePaymentSystem: 成功 {success: true, enabled: true}
```

#### 如果失败，会看到：

```javascript
❌ togglePaymentSystem: 未找到用户
// 或
❌ togglePaymentSystem: RPC 错误 {message: "...", details: "...", hint: "...", code: "..."}
```

### 步骤 4: 测试邮件发送

#### 测试管理员邮箱（1062250152@qq.com）

1. 在登录页面输入：1062250152@qq.com
2. 点击"发送验证码"
3. **查看控制台和邮箱**

预期结果：
- 尝试发送真实邮件
- 如果成功：收到邮件
- 如果失败：显示验证码弹窗

#### 测试其他邮箱（如：test@example.com）

1. 在登录页面输入：test@example.com
2. 点击"发送验证码"
3. **查看弹窗和控制台**

预期结果：
- 不发送邮件
- 直接显示验证码弹窗
- 控制台显示：
  ```javascript
  ==================================================
  开发模式：验证码未通过邮件发送
  邮箱：test@example.com
  验证码：123456
  ==================================================
  ```

---

## 📋 错误排查清单

### 问题 1: 礼品码生成失败

#### 可能的错误信息和解决方案：

**错误 1: "❌ generateGiftCode: 未找到用户"**
- **原因：** getCurrentUser() 返回 null
- **解决：** 
  1. 检查是否已登录
  2. 刷新页面（Ctrl+F5）
  3. 重新登录

**错误 2: "❌ generateGiftCode: RPC 生成码失败"**
- **原因：** `generate_gift_code()` 函数调用失败
- **解决：**
  1. 检查数据库连接
  2. 查看错误详情中的 `message` 和 `hint`
  3. 可能需要重新应用数据库迁移

**错误 3: "❌ generateGiftCode: 插入失败"**
- **原因：** 插入 `gift_codes` 表失败
- **可能原因：**
  - RLS 策略阻止（应该已禁用）
  - 字段验证失败
  - 数据库权限问题
- **解决：**
  1. 查看错误详情中的 `message`
  2. 检查 Supabase Dashboard 中的表结构
  3. 确认 RLS 已禁用

### 问题 2: 支付系统切换失败

#### 可能的错误信息和解决方案：

**错误 1: "❌ togglePaymentSystem: 未找到用户"**
- **原因：** getCurrentUser() 返回 null
- **解决：** 同礼品码问题 1

**错误 2: "❌ togglePaymentSystem: RPC 错误"**
- **可能的错误代码：**
  - `42883`: 函数不存在
  - `42P01`: 表不存在
  - `23505`: 唯一约束冲突
  - `PGRST204`: 无结果返回

- **解决方案：**
  1. 检查 `toggle_payment_system` 函数是否存在
  2. 检查函数参数是否正确
  3. 查看 Supabase Dashboard → SQL Editor
  4. 运行：
     ```sql
     SELECT * FROM pg_proc WHERE proname = 'toggle_payment_system';
     ```

### 问题 3: 邮件发送问题

#### 管理员邮箱不发送邮件

**检查清单：**
1. ✅ RESEND_API_KEY 是否配置？
   - 登录 Supabase Dashboard
   - 进入 Edge Functions → Secrets
   - 检查 `RESEND_API_KEY` 是否存在

2. ✅ Resend 账户是否正常？
   - 登录 Resend 控制台
   - 检查 API 密钥是否有效
   - 检查发送配额

3. ✅ 邮箱地址是否正确？
   - 确认是 `1062250152@qq.com`（小写）
   - 检查是否有空格

#### 其他邮箱显示错误

**如果其他邮箱没有显示验证码弹窗：**
1. 检查浏览器是否拦截弹窗
2. 查看控制台是否有验证码输出
3. 检查 Network 标签中的响应

---

## 🔧 数据库检查

### 检查 RLS 状态

登录 Supabase Dashboard，运行以下 SQL：

```sql
-- 检查 gift_codes 表的 RLS 状态
SELECT 
  schemaname,
  tablename,
  rowsecurity
FROM pg_tables
WHERE tablename IN ('gift_codes', 'gift_code_redemptions', 'system_settings');
```

**预期结果：**
- `gift_codes`: `rowsecurity = false` (RLS 已禁用)
- `gift_code_redemptions`: `rowsecurity = false` (RLS 已禁用)
- `system_settings`: `rowsecurity = true` (RLS 启用，有正确的策略)

### 检查函数是否存在

```sql
-- 检查所有相关函数
SELECT 
  proname as function_name,
  pg_get_function_arguments(oid) as arguments
FROM pg_proc
WHERE proname IN (
  'toggle_payment_system',
  'is_admin_by_id',
  'log_admin_action',
  'generate_gift_code'
);
```

**预期结果：**
应该看到所有 4 个函数，包括它们的参数。

### 检查管理员权限

```sql
-- 检查您的用户是否为管理员
SELECT 
  id,
  email,
  role
FROM profiles
WHERE email = '1062250152@qq.com';
```

**预期结果：**
- `role` 应该是 `'admin'`

---

## 📊 网络请求检查

### 使用 Network 标签

1. 打开浏览器开发者工具
2. 切换到 **Network** 标签
3. 执行操作（生成礼品码、切换支付系统等）
4. 查看请求详情

#### 礼品码生成请求

**请求 1: generate_gift_code RPC**
```
URL: /rest/v1/rpc/generate_gift_code
Method: POST
Status: 应该是 200
Response: "A3K7N9P2" (随机码)
```

**请求 2: gift_codes INSERT**
```
URL: /rest/v1/gift_codes
Method: POST
Status: 应该是 201
Response: {id: "...", code: "A3K7N9P2", ...}
```

如果看到 **401** 或 **403**：
- RLS 可能仍然启用
- 需要重新应用迁移 10

如果看到 **400**：
- 请求参数错误
- 查看 Response 中的错误详情

#### 支付系统切换请求

```
URL: /rest/v1/rpc/toggle_payment_system
Method: POST
Body: {"enabled": true, "user_id": "..."}
Status: 应该是 200
Response: {"success": true, "enabled": true}
```

如果看到 **400**：
- 函数参数错误
- 查看 Response 中的 `message` 和 `hint`

---

## 🎯 快速诊断命令

### 在浏览器控制台运行

```javascript
// 检查当前用户
const checkUser = async () => {
  const { data: { user } } = await window.getCurrentUser();
  console.log('当前用户:', user);
  console.log('用户ID:', user?.id);
  console.log('邮箱:', user?.email);
  console.log('角色:', user?.role);
};
checkUser();

// 测试 RPC 调用
const testRPC = async () => {
  const { data, error } = await window.supabase.rpc('generate_gift_code');
  console.log('RPC 结果:', { data, error });
};
testRPC();

// 检查 Supabase 连接
console.log('Supabase URL:', import.meta.env.VITE_SUPABASE_URL);
console.log('Supabase Key:', import.meta.env.VITE_SUPABASE_ANON_KEY?.substring(0, 20) + '...');
```

---

## 📝 报告问题时请提供

如果问题仍然存在，请提供以下信息：

1. **控制台完整输出**
   - 包括所有 ❌ 错误信息
   - 包括错误详情（message, details, hint, code）

2. **Network 请求详情**
   - 请求 URL
   - 请求 Method
   - 请求 Body
   - 响应 Status
   - 响应 Body

3. **数据库检查结果**
   - RLS 状态查询结果
   - 函数存在性查询结果
   - 管理员权限查询结果

4. **操作步骤**
   - 详细描述您执行的操作
   - 在哪个页面
   - 点击了什么按钮

---

## ✅ 成功标志

### 礼品码生成成功

控制台输出：
```javascript
🎁 generateGiftCode: 开始生成
✅ generateGiftCode: 生成随机码 "A3K7N9P2"
🎁 generateGiftCode: 插入数据库
✅ generateGiftCode: 成功
```

页面显示：
- Toast 提示"礼品码生成成功"
- 礼品码列表中出现新的礼品码

### 支付系统切换成功

控制台输出：
```javascript
🔧 togglePaymentSystem: 调用 RPC
✅ togglePaymentSystem: 成功
```

页面显示：
- 开关状态立即改变
- Toast 提示"支付系统已启用/禁用"

### 邮件发送成功

**管理员邮箱：**
- 收到真实邮件（或显示验证码弹窗）
- Toast 提示"验证码已发送到您的邮箱"

**其他邮箱：**
- 显示验证码弹窗
- 控制台输出验证码
- Toast 提示"验证码已生成（开发模式）"

---

**最后更新：** 2025-11-10  
**状态：** 已添加详细日志，等待测试反馈
