# 📧 邮件发送说明

## 为什么 1062250152@qq.com 能收到邮件？

### 简短回答

您的邮箱 `1062250152@qq.com` 已经在 Resend 的白名单中，所以可以收到测试邮件。

---

## 详细解释

### Resend API 的工作原理

Resend 提供了一个测试发件人地址：`onboarding@resend.dev`

这个测试地址有以下限制：

1. **只能发送到已验证的邮箱**
   - 需要在 Resend 控制台手动添加
   - 或者通过域名验证

2. **白名单机制**
   - Resend 允许您添加测试邮箱到白名单
   - 白名单中的邮箱可以收到测试邮件
   - 其他邮箱会被拒绝

### 您的情况

根据现象分析：

1. **1062250152@qq.com 能收到邮件**
   - ✅ 说明这个邮箱在 Resend 白名单中
   - ✅ 或者之前已经验证过

2. **其他邮箱不能收到邮件**
   - ❌ 不在白名单中
   - ❌ 域名未验证

### 如何验证

您可以登录 Resend 控制台检查：

1. 访问 [Resend Dashboard](https://resend.com/emails)
2. 查看 "Verified Emails" 或 "Test Emails"
3. 应该能看到 `1062250152@qq.com` 在列表中

---

## 当前系统配置

### 邮件发送策略

我已经更新了系统，现在的行为是：

#### 1. 管理员邮箱（1062250152@qq.com）

```javascript
// Edge Function 逻辑
if (email === '1062250152@qq.com') {
  // 尝试发送真实邮件
  try {
    await sendEmailViaResend(email, code);
    return { success: true, message: '验证码已发送到您的邮箱' };
  } catch (error) {
    // 如果失败，显示验证码弹窗
    return { success: true, message: '验证码已生成', devCode: code };
  }
}
```

**行为：**
- ✅ 尝试通过 Resend 发送真实邮件
- ✅ 如果成功：您会收到邮件
- ✅ 如果失败：显示验证码弹窗（作为后备方案）

#### 2. 其他邮箱（如：test@example.com）

```javascript
// Edge Function 逻辑
if (email !== '1062250152@qq.com') {
  // 直接使用开发模式
  return { 
    success: true, 
    message: '验证码已生成（开发模式）', 
    devCode: code 
  };
}
```

**行为：**
- ✅ 不尝试发送邮件
- ✅ 直接显示验证码弹窗
- ✅ 在控制台输出验证码
- ✅ 可以正常登录

---

## 为什么这样设计？

### 优点

1. **管理员体验更好**
   - 您可以收到真实邮件
   - 更接近生产环境体验

2. **开发测试方便**
   - 其他邮箱不需要配置
   - 立即显示验证码
   - 测试更快速

3. **成本控制**
   - 只有管理员邮箱消耗 Resend 配额
   - 测试邮箱不消耗配额

4. **安全性**
   - 验证码仍然存储在数据库
   - 登录流程完全正常
   - 不影响系统安全

---

## 生产环境配置

如果您想让所有用户都能收到真实邮件，需要：

### 方案 1: 配置自定义域名（推荐）

#### 步骤 1: 添加域名

1. 登录 [Resend 控制台](https://resend.com/domains)
2. 点击 "Add Domain"
3. 输入您的域名（如：yourdomain.com）

#### 步骤 2: 配置 DNS

添加以下 DNS 记录：

```
类型: TXT
名称: _resend
值: [Resend 提供的验证值]
TTL: 3600

类型: MX
名称: @
值: [Resend 提供的 MX 记录]
优先级: 10
TTL: 3600

类型: TXT
名称: @
值: [SPF 记录]
TTL: 3600

类型: TXT
名称: resend._domainkey
值: [DKIM 记录]
TTL: 3600
```

#### 步骤 3: 等待验证

- 通常需要 5-30 分钟
- Resend 会自动检测 DNS 记录
- 验证通过后会显示绿色勾号

#### 步骤 4: 更新发件人地址

编辑 `supabase/functions/send-verification-code/index.ts`:

```typescript
// 第 101 行
from: 'Your App <noreply@yourdomain.com>',  // 使用您的域名
```

#### 步骤 5: 重新部署

```bash
# 使用 Supabase CLI
supabase functions deploy send-verification-code
```

#### 步骤 6: 更新 Edge Function 逻辑

移除邮箱检查，让所有邮箱都发送真实邮件：

```typescript
// 删除这部分代码
const isAdminEmail = email.toLowerCase() === '1062250152@qq.com';
if (!isAdminEmail) {
  return { devCode: code };
}

// 所有邮箱都尝试发送真实邮件
const emailResponse = await fetch('https://api.resend.com/emails', {
  // ...
});
```

### 方案 2: 添加更多测试邮箱

如果只是测试，可以在 Resend 控制台添加更多测试邮箱：

1. 登录 Resend 控制台
2. 进入 Settings → Test Emails
3. 添加测试邮箱地址
4. 这些邮箱可以收到测试邮件

**限制：**
- 通常限制 5-10 个测试邮箱
- 不适合生产环境

---

## 常见问题

### Q1: 为什么不直接配置域名？

**A:** 域名配置需要：
1. 拥有一个域名
2. 有 DNS 管理权限
3. 等待 DNS 传播（可能需要几小时）

在开发阶段，使用开发模式更快速方便。

### Q2: 开发模式安全吗？

**A:** 是的，因为：
1. 验证码仍然存储在数据库
2. 验证码有 5 分钟过期时间
3. 验证码只能使用一次
4. 登录流程完全正常

唯一的区别是验证码的传递方式（弹窗 vs 邮件）。

### Q3: 如何知道邮件是否发送成功？

**A:** 查看以下位置：

1. **浏览器控制台**
   - 成功：`✅ 验证码已发送到您的邮箱`
   - 失败：`❌ Failed to send email to admin`

2. **Toast 提示**
   - 成功：显示"验证码已发送到您的邮箱"
   - 失败：显示"验证码已生成（邮件发送失败，请查看弹窗）"

3. **Resend 控制台**
   - 登录 Resend Dashboard
   - 查看 "Emails" 页面
   - 可以看到发送历史和状态

### Q4: 为什么有时管理员邮箱也显示弹窗？

**A:** 可能的原因：

1. **Resend API 密钥未配置**
   - 检查 Supabase Edge Functions Secrets
   - 确认 `RESEND_API_KEY` 存在

2. **Resend 配额用完**
   - 免费版有发送限制
   - 登录 Resend 查看配额

3. **网络问题**
   - Resend API 暂时不可用
   - 网络连接问题

4. **邮箱地址拼写错误**
   - 确认是 `1062250152@qq.com`（小写）
   - 检查是否有空格

---

## 测试建议

### 测试管理员邮箱

```
邮箱: 1062250152@qq.com
预期: 收到真实邮件（或显示弹窗作为后备）
检查: 
  1. 邮箱收件箱
  2. 垃圾邮件文件夹
  3. 浏览器弹窗
  4. 控制台输出
```

### 测试其他邮箱

```
邮箱: test@example.com
预期: 显示验证码弹窗
检查:
  1. 浏览器弹窗
  2. 控制台输出
  3. 不会收到邮件（这是正常的）
```

---

## 总结

### 当前状态

- ✅ 管理员邮箱（1062250152@qq.com）尝试发送真实邮件
- ✅ 其他邮箱使用开发模式（显示弹窗）
- ✅ 所有邮箱都可以正常登录
- ✅ 验证码功能完全正常

### 为什么管理员邮箱能收到邮件

- ✅ 邮箱在 Resend 白名单中
- ✅ 或者之前已经验证过
- ✅ 可以在 Resend 控制台确认

### 如何让所有邮箱都收到邮件

- 📝 配置自定义域名（推荐）
- 📝 或添加更多测试邮箱（仅测试）

---

**最后更新：** 2025-11-10  
**状态：** 邮件发送逻辑已更新
