# 礼品码系统使用指南

## 📦 系统概述

礼品码系统允许管理员生成特殊的兑换码，用户使用礼品码后可获得 **15 次免费分析**，无需支付即可体验完整的投资心理分析服务。

### 核心特性

- ✅ 随机生成 8 位礼品码（最多 10 位）
- ✅ 每个礼品码提供 15 次免费分析
- ✅ 支持设置使用次数限制
- ✅ 支持设置有效期
- ✅ 实时追踪使用情况
- ✅ 管理员可随时停用/激活礼品码

---

## 🎯 管理员操作指南

### 1. 生成礼品码

#### 访问管理后台

1. 登录管理员账号
2. 访问 `/admin` 管理后台
3. 点击 **"礼品码管理"** 标签

#### 创建新礼品码

在"生成礼品码"卡片中：

1. **设置最大使用次数**
   - 默认：1（一人一码）
   - 可设置为任意正整数
   - 例如：设置为 100，表示这个码可以被 100 个不同用户使用

2. **设置有效期（可选）**
   - 留空：永久有效
   - 填写天数：从生成日期起计算
   - 例如：填写 30，表示 30 天后过期

3. **点击"生成礼品码"按钮**
   - 系统自动生成 8 位随机码
   - 礼品码格式：大写字母 + 数字（排除易混淆字符）
   - 示例：`A3K7N2P9`

#### 礼品码示例

```
┌─────────────────────────────────────────┐
│ 生成礼品码                               │
├─────────────────────────────────────────┤
│ 最大使用次数: [1]                        │
│ 有效期（天）: [留空]                     │
│                                         │
│ [生成礼品码]                             │
└─────────────────────────────────────────┘

生成结果: A3K7N2P9
```

### 2. 管理礼品码

#### 查看礼品码列表

在"礼品码列表"中可以看到：

- **礼品码**：完整的兑换码
- **状态**：有效/已停用
- **免费次数**：15 次
- **使用情况**：已使用 / 最大使用次数
- **有效期**：过期时间或"永久有效"
- **剩余次数**：所有用户剩余的总次数

#### 礼品码卡片示例

```
┌─────────────────────────────────────────────────┐
│ A3K7N2P9  [复制]  [有效]                        │
│                                                 │
│ ⚡ 15 次免费分析                                 │
│ 👥 3 / 100 已使用                               │
│ 📅 永久有效                                     │
│                                                 │
│ 剩余 42 次免费分析待使用                         │
│                                                 │
│ 创建者: admin@example.com · 2025-01-10         │
│                                    [停用]       │
└─────────────────────────────────────────────────┘
```

#### 复制礼品码

1. 点击礼品码旁边的 **[复制]** 按钮
2. 礼品码自动复制到剪贴板
3. 可以通过邮件、微信等方式分享给用户

#### 停用礼品码

1. 找到要停用的礼品码
2. 点击 **[停用]** 按钮
3. 礼品码立即失效，用户无法再兑换

#### 激活礼品码

1. 找到已停用的礼品码
2. 点击 **[激活]** 按钮
3. 礼品码重新生效

### 3. 使用场景

#### 场景 1：限时活动

```
目的：新年促销，前 100 名用户免费体验
设置：
- 最大使用次数：100
- 有效期：7 天
- 礼品码：NEWYEAR24

分享方式：
- 在社交媒体发布
- 发送给邮件订阅用户
- 在网站首页展示
```

#### 场景 2：VIP 专属

```
目的：为 VIP 客户提供专属福利
设置：
- 最大使用次数：1
- 有效期：永久
- 礼品码：VIP12345

分享方式：
- 一对一发送给 VIP 客户
- 每个客户独立的礼品码
```

#### 场景 3：合作伙伴

```
目的：与合作伙伴联合推广
设置：
- 最大使用次数：500
- 有效期：30 天
- 礼品码：PARTNER2024

分享方式：
- 提供给合作伙伴
- 在合作渠道推广
```

---

## 👥 用户使用指南

### 1. 兑换礼品码

#### 步骤 1：完成测试

1. 登录系统
2. 完成人格测试、数学金融测试、风险偏好测试
3. 进入结果页面

#### 步骤 2：找到兑换入口

在购买分析卡片中：

1. 找到 **"有礼品码？点击兑换"** 按钮
2. 点击按钮展开兑换界面

#### 步骤 3：输入礼品码

1. 在输入框中输入礼品码
2. 礼品码自动转换为大写
3. 点击 **"兑换"** 按钮

#### 步骤 4：兑换成功

- 显示成功提示：**"礼品码兑换成功！"**
- 自动获得 15 次免费分析
- 页面刷新显示免费次数

### 2. 使用免费次数

#### 查看剩余次数

兑换成功后，购买卡片会显示：

```
┌─────────────────────────────────────────┐
│ 🎁 您有免费分析次数                      │
│                          剩余 15 次      │
│                                         │
│ [免费获取深度分析]                       │
│                                         │
│ 使用礼品码免费次数，无需支付              │
└─────────────────────────────────────────┘
```

#### 使用免费分析

1. 点击 **"免费获取深度分析"** 按钮
2. 系统自动消耗 1 次免费次数
3. 开始生成 AI 分析报告
4. 剩余次数自动减 1

#### 次数用完后

- 免费次数用完后，自动显示付费购买选项
- 可以继续兑换其他礼品码
- 或选择付费购买（享受阶梯定价优惠）

### 3. 常见问题

#### Q: 礼品码在哪里输入？

**A:** 在测试结果页面的购买分析卡片中，点击"有礼品码？点击兑换"按钮。

#### Q: 礼品码区分大小写吗？

**A:** 不区分。系统会自动将输入转换为大写。

#### Q: 一个礼品码可以使用多次吗？

**A:** 每个用户只能使用同一个礼品码一次。但如果礼品码设置了多次使用，其他用户也可以使用。

#### Q: 礼品码会过期吗？

**A:** 取决于管理员设置。有些礼品码永久有效，有些有时间限制。

#### Q: 免费次数可以累积吗？

**A:** 可以。如果您兑换了多个礼品码，免费次数会累加。

#### Q: 免费次数会过期吗？

**A:** 不会。一旦兑换成功，免费次数永久有效，直到用完。

---

## 🔧 技术实现

### 数据库结构

#### gift_codes 表

```sql
CREATE TABLE gift_codes (
  id uuid PRIMARY KEY,
  code text UNIQUE NOT NULL,              -- 礼品码
  max_redemptions integer DEFAULT 1,      -- 最大使用次数
  current_redemptions integer DEFAULT 0,  -- 当前使用次数
  free_analyses_count integer DEFAULT 15, -- 免费分析次数
  created_by uuid,                        -- 创建者
  is_active boolean DEFAULT true,         -- 是否有效
  expires_at timestamptz,                 -- 过期时间
  created_at timestamptz DEFAULT now()
);
```

#### gift_code_redemptions 表

```sql
CREATE TABLE gift_code_redemptions (
  id uuid PRIMARY KEY,
  gift_code_id uuid,                      -- 礼品码ID
  user_id uuid,                           -- 用户ID
  redeemed_at timestamptz DEFAULT now(),  -- 兑换时间
  remaining_analyses integer DEFAULT 15,  -- 剩余次数
  UNIQUE(gift_code_id, user_id)          -- 每个用户只能兑换一次
);
```

### 核心函数

#### 生成礼品码

```sql
CREATE FUNCTION generate_gift_code()
RETURNS text
```

- 生成 8 位随机码
- 使用大写字母和数字
- 排除易混淆字符（O、0、I、1、L）

#### 兑换礼品码

```sql
CREATE FUNCTION redeem_gift_code(p_code text, p_user_id uuid)
RETURNS jsonb
```

- 验证礼品码有效性
- 检查是否已兑换
- 检查使用次数限制
- 创建兑换记录

#### 获取免费次数

```sql
CREATE FUNCTION get_user_free_analyses(p_user_id uuid)
RETURNS integer
```

- 统计用户所有礼品码的剩余次数
- 返回总计可用次数

#### 消耗免费次数

```sql
CREATE FUNCTION consume_free_analysis(p_user_id uuid)
RETURNS boolean
```

- 从最早兑换的礼品码开始消耗
- 自动减少剩余次数
- 返回是否成功

### API 接口

#### 管理员 API

```typescript
// 生成礼品码
giftCodeApi.generateGiftCode(maxRedemptions, expiresInDays)

// 获取所有礼品码
giftCodeApi.getAllGiftCodes()

// 停用礼品码
giftCodeApi.deactivateGiftCode(codeId)

// 激活礼品码
giftCodeApi.activateGiftCode(codeId)
```

#### 用户 API

```typescript
// 兑换礼品码
giftCodeApi.redeemGiftCode(code)

// 获取剩余次数
giftCodeApi.getUserFreeAnalyses()

// 使用免费次数
giftCodeApi.consumeFreeAnalysis()

// 获取兑换记录
giftCodeApi.getUserRedemptions()
```

---

## 📊 数据统计

### 管理员视图

在礼品码列表中可以看到：

1. **总生成数量**：已创建的礼品码总数
2. **有效礼品码**：当前可用的礼品码数量
3. **总兑换次数**：所有礼品码被兑换的总次数
4. **剩余免费次数**：所有用户剩余的总次数

### 查询统计数据

```sql
-- 查看礼品码统计
SELECT * FROM gift_code_stats;

-- 查看用户兑换记录
SELECT 
  u.email,
  gc.code,
  gcr.redeemed_at,
  gcr.remaining_analyses
FROM gift_code_redemptions gcr
JOIN profiles u ON u.id = gcr.user_id
JOIN gift_codes gc ON gc.id = gcr.gift_code_id
ORDER BY gcr.redeemed_at DESC;

-- 统计礼品码使用情况
SELECT 
  COUNT(*) as total_codes,
  SUM(current_redemptions) as total_redemptions,
  SUM(CASE WHEN is_active THEN 1 ELSE 0 END) as active_codes
FROM gift_codes;
```

---

## 🛡️ 安全机制

### 1. 权限控制

- ✅ 只有管理员可以生成礼品码
- ✅ 只有管理员可以查看所有礼品码
- ✅ 用户只能查看自己的兑换记录

### 2. 防止滥用

- ✅ 每个用户只能兑换同一个礼品码一次
- ✅ 礼品码有使用次数限制
- ✅ 支持设置有效期
- ✅ 管理员可随时停用礼品码

### 3. 数据完整性

- ✅ 礼品码唯一性约束
- ✅ 用户兑换记录唯一性约束
- ✅ 礼品码长度限制（最多 10 位）
- ✅ 级联删除保护

---

## 💡 最佳实践

### 1. 礼品码命名

**推荐格式：**
- 活动相关：`NEWYEAR24`、`SPRING2024`
- 渠道相关：`WECHAT01`、`EMAIL01`
- 合作伙伴：`PARTNER01`、`VIP001`

**避免：**
- 过于简单：`123456`、`AAAAAA`
- 易混淆：包含 O/0、I/1、L 等字符

### 2. 使用次数设置

| 场景 | 推荐设置 | 说明 |
|------|---------|------|
| 个人专属 | 1 | 一人一码，精准追踪 |
| 小范围分享 | 10-50 | 朋友圈、小群组 |
| 公开活动 | 100-500 | 社交媒体、公开渠道 |
| 大型推广 | 1000+ | 大规模营销活动 |

### 3. 有效期设置

| 场景 | 推荐设置 | 说明 |
|------|---------|------|
| 限时活动 | 7-30 天 | 创造紧迫感 |
| 长期合作 | 90-180 天 | 给予充足时间 |
| VIP 福利 | 永久 | 体现尊贵感 |

### 4. 分发策略

**精准分发：**
- 一对一发送给目标用户
- 每个用户独立的礼品码
- 便于追踪转化效果

**批量分发：**
- 在社交媒体公开发布
- 设置合理的使用次数限制
- 监控使用情况，及时调整

---

## 🔍 故障排除

### 问题 1：礼品码无法兑换

**可能原因：**
1. 礼品码已过期
2. 礼品码已停用
3. 用户已兑换过此码
4. 礼品码已达最大使用次数

**解决方法：**
```sql
-- 检查礼品码状态
SELECT * FROM gift_codes WHERE code = 'YOUR_CODE';

-- 检查用户是否已兑换
SELECT * FROM gift_code_redemptions 
WHERE gift_code_id = 'code_id' AND user_id = 'user_id';
```

### 问题 2：免费次数显示不正确

**解决方法：**
```sql
-- 查询用户实际剩余次数
SELECT get_user_free_analyses('user_id');

-- 查看用户所有兑换记录
SELECT * FROM gift_code_redemptions 
WHERE user_id = 'user_id';
```

### 问题 3：礼品码生成失败

**可能原因：**
1. 用户不是管理员
2. 数据库连接问题

**解决方法：**
```sql
-- 检查用户角色
SELECT role FROM profiles WHERE id = 'user_id';

-- 手动生成礼品码
SELECT generate_gift_code();
```

---

## 📈 运营建议

### 1. 新用户获取

- 在首页显著位置提供礼品码入口
- 社交媒体定期发布限量礼品码
- 合作伙伴渠道推广

### 2. 用户激活

- 新注册用户自动发送礼品码
- 邮件营销附带礼品码
- 节日活动特别礼品码

### 3. 用户留存

- 完成测试后赠送礼品码
- 推荐好友奖励礼品码
- 定期回馈老用户

### 4. 数据分析

定期分析：
- 礼品码兑换率
- 免费次数使用率
- 免费用户转化为付费用户的比例
- 不同渠道礼品码的效果

---

## 🎉 总结

礼品码系统为您提供了灵活的用户获取和激活工具：

- ✅ **简单易用**：管理员一键生成，用户轻松兑换
- ✅ **灵活配置**：支持多种使用场景
- ✅ **安全可靠**：完善的权限控制和防滥用机制
- ✅ **数据追踪**：实时监控使用情况

通过合理使用礼品码系统，您可以：
- 降低用户体验门槛
- 提高用户转化率
- 增强用户粘性
- 扩大品牌影响力

**祝您使用愉快！** 🚀
