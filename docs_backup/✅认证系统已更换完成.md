# âœ… è®¤è¯ç³»ç»Ÿå·²æ›´æ¢å®Œæˆ

## ğŸ‰ å®ŒæˆçŠ¶æ€

æ‚¨çš„ç³»ç»Ÿå·²æˆåŠŸä» Supabase Auth åˆ‡æ¢åˆ°è‡ªå®šä¹‰ JWT è®¤è¯ç³»ç»Ÿï¼

---

## ğŸ“Š æ›´æ”¹æ‘˜è¦

### ç§»é™¤çš„ä¾èµ–
- âŒ Supabase Auth (`supabase.auth.signInWithOtp`)
- âŒ Supabase Auth (`supabase.auth.verifyOtp`)
- âŒ `auth.users` è¡¨ä¾èµ–

### æ–°å¢çš„åŠŸèƒ½
- âœ… è‡ªå®šä¹‰ JWT è®¤è¯ç³»ç»Ÿ
- âœ… 3 ä¸ª Edge Functions
- âœ… å®Œå…¨ç‹¬ç«‹çš„ç”¨æˆ·ç®¡ç†
- âœ… ä½¿ç”¨ç°æœ‰çš„ `users` å’Œ `verification_codes` è¡¨

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### åç«¯ Edge Functions

#### 1. send-verification-code
**åŠŸèƒ½**: å‘é€6ä½æ•°å­—éªŒè¯ç åˆ°ç”¨æˆ·é‚®ç®±

**æµç¨‹**:
```
ç”¨æˆ·è¾“å…¥é‚®ç®±
  â†“
ç”Ÿæˆ6ä½éšæœºæ•°å­—éªŒè¯ç 
  â†“
å­˜å‚¨åˆ° verification_codes è¡¨
  â†“
é€šè¿‡ Resend API å‘é€é‚®ä»¶
  â†“
è¿”å›æˆåŠŸå“åº”
```

**æ•°æ®åº“æ“ä½œ**:
- æ’å…¥è®°å½•åˆ° `verification_codes` è¡¨
- è®¾ç½®5åˆ†é’Ÿè¿‡æœŸæ—¶é—´

#### 2. verify-code-and-login
**åŠŸèƒ½**: éªŒè¯éªŒè¯ç å¹¶ç”Ÿæˆ JWT token

**æµç¨‹**:
```
ç”¨æˆ·è¾“å…¥é‚®ç®±å’ŒéªŒè¯ç 
  â†“
éªŒè¯ verification_codes è¡¨ä¸­çš„è®°å½•
  â†“
æ ‡è®°éªŒè¯ç ä¸ºå·²ä½¿ç”¨
  â†“
è·å–æˆ–åˆ›å»º users è¡¨ä¸­çš„ç”¨æˆ·
  â†“
ç”Ÿæˆ JWT token (30å¤©æœ‰æ•ˆæœŸ)
  â†“
è¿”å› token å’Œç”¨æˆ·ä¿¡æ¯
```

**JWT Payload**:
```json
{
  "sub": "user_id",
  "email": "user@example.com",
  "iat": 1234567890,
  "exp": 1237159890
}
```

#### 3. verify-token
**åŠŸèƒ½**: éªŒè¯ JWT token æœ‰æ•ˆæ€§

**æµç¨‹**:
```
æ¥æ”¶ Authorization: Bearer <token>
  â†“
éªŒè¯ JWT ç­¾åå’Œè¿‡æœŸæ—¶é—´
  â†“
ä» users è¡¨è·å–ç”¨æˆ·ä¿¡æ¯
  â†“
è¿”å›ç”¨æˆ·ä¿¡æ¯
```

---

## ğŸ¨ å‰ç«¯å®ç°

### AuthContext
**ä½ç½®**: `src/contexts/AuthContext.tsx`

**æä¾›çš„æ–¹æ³•**:
- `sendVerificationCode(email)` - å‘é€éªŒè¯ç 
- `verifyCodeAndLogin(email, code)` - éªŒè¯ç™»å½•
- `logout()` - ç™»å‡º
- `user` - å½“å‰ç”¨æˆ·ä¿¡æ¯
- `loading` - åŠ è½½çŠ¶æ€
- `isAuthenticated` - æ˜¯å¦å·²ç™»å½•

**Token å­˜å‚¨**:
- å­˜å‚¨ä½ç½®: `localStorage.setItem('auth_token', token)`
- è‡ªåŠ¨éªŒè¯: é¡µé¢åˆ·æ–°æ—¶è‡ªåŠ¨éªŒè¯ token
- è‡ªåŠ¨æ¸…ç†: token æ— æ•ˆæ—¶è‡ªåŠ¨æ¸…é™¤

### LoginPage
**ä½ç½®**: `src/pages/LoginPage.tsx`

**æ›´æ–°å†…å®¹**:
- ä½¿ç”¨ `sendVerificationCode()` æ›¿ä»£ `supabase.auth.signInWithOtp()`
- ä½¿ç”¨ `verifyCodeAndLogin()` æ›¿ä»£ `supabase.auth.verifyOtp()`
- ç§»é™¤äº† `userApi.upsertUser()` è°ƒç”¨ï¼ˆç°åœ¨åœ¨ Edge Function ä¸­å¤„ç†ï¼‰

---

## ğŸ” å®‰å…¨é…ç½®

### JWT Secret
**å½“å‰å€¼**: `your-super-secret-jwt-key-change-this-in-production-min-32-chars`

**âš ï¸ é‡è¦**: è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶å¯†é’¥ï¼Œç”Ÿäº§ç¯å¢ƒä¸­å¿…é¡»æ›´æ¢ï¼

**å¦‚ä½•æ›´æ¢**:
1. ç”Ÿæˆä¸€ä¸ªå¼ºéšæœºå¯†é’¥ï¼ˆè‡³å°‘32ä¸ªå­—ç¬¦ï¼‰
2. åœ¨ Supabase Dashboard ä¸­æ›´æ–°:
   - Settings â†’ Edge Functions â†’ Secrets
   - æ‰¾åˆ° `JWT_SECRET`
   - ç‚¹å‡» Edit
   - è¾“å…¥æ–°å¯†é’¥
   - ä¿å­˜

**ç”Ÿæˆå¼ºå¯†é’¥çš„æ–¹æ³•**:
```bash
# æ–¹æ³• 1: ä½¿ç”¨ OpenSSL
openssl rand -base64 32

# æ–¹æ³• 2: ä½¿ç”¨ Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

# æ–¹æ³• 3: åœ¨çº¿ç”Ÿæˆ
# è®¿é—®: https://generate-secret.vercel.app/32
```

---

## ğŸ“§ é‚®ä»¶é…ç½®

### Resend API Key
**å½“å‰å€¼**: `re_placeholder_get_from_resend_com`

**âš ï¸ å¿…é¡»é…ç½®**: æ²¡æœ‰æœ‰æ•ˆçš„ API Key æ— æ³•å‘é€é‚®ä»¶ï¼

### å¦‚ä½•è·å– Resend API Key

#### æ­¥éª¤ 1: æ³¨å†Œ Resend è´¦å·
1. è®¿é—®: https://resend.com
2. ç‚¹å‡» "Sign Up"
3. ä½¿ç”¨ GitHub æˆ–é‚®ç®±æ³¨å†Œ

#### æ­¥éª¤ 2: åˆ›å»º API Key
1. ç™»å½•åè¿›å…¥ Dashboard
2. ç‚¹å‡»å·¦ä¾§ "API Keys"
3. ç‚¹å‡» "Create API Key"
4. è¾“å…¥åç§°ï¼ˆå¦‚ "Production"ï¼‰
5. é€‰æ‹©æƒé™: "Sending access"
6. ç‚¹å‡» "Create"
7. **ç«‹å³å¤åˆ¶ API Key**ï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼ï¼‰

#### æ­¥éª¤ 3: é…ç½®åˆ° Supabase
1. æ‰“å¼€ Supabase Dashboard
2. è¿›å…¥æ‚¨çš„é¡¹ç›®
3. Settings â†’ Edge Functions â†’ Secrets
4. æ‰¾åˆ° `RESEND_API_KEY`
5. ç‚¹å‡» Edit
6. ç²˜è´´æ‚¨çš„ Resend API Key
7. ä¿å­˜

#### æ­¥éª¤ 4: é…ç½®å‘ä»¶åŸŸåï¼ˆå¯é€‰ä½†æ¨èï¼‰
**ä½¿ç”¨é»˜è®¤åŸŸå**:
- Resend æä¾›æµ‹è¯•åŸŸå `onboarding@resend.dev`
- å¯ä»¥ç«‹å³ä½¿ç”¨ï¼Œä½†æœ‰é™åˆ¶

**ä½¿ç”¨è‡ªå®šä¹‰åŸŸå**:
1. åœ¨ Resend Dashboard ä¸­ç‚¹å‡» "Domains"
2. ç‚¹å‡» "Add Domain"
3. è¾“å…¥æ‚¨çš„åŸŸåï¼ˆå¦‚ `yourdomain.com`ï¼‰
4. æ·»åŠ  DNS è®°å½•ï¼ˆResend ä¼šæä¾›å…·ä½“è®°å½•ï¼‰
5. ç­‰å¾…éªŒè¯é€šè¿‡
6. æ›´æ–° Edge Function ä¸­çš„ `from` å­—æ®µ:
   ```typescript
   from: 'noreply@yourdomain.com'  // æ”¹ä¸ºæ‚¨çš„åŸŸå
   ```

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### 1. é…ç½® Resend API Key
æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤é…ç½® API Key

### 2. æµ‹è¯•å‘é€éªŒè¯ç 
1. æ‰“å¼€åº”ç”¨ç™»å½•é¡µé¢
2. è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€
3. ç‚¹å‡»"å‘é€éªŒè¯ç "
4. æ£€æŸ¥é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰
5. åº”è¯¥æ”¶åˆ°åŒ…å«6ä½æ•°å­—éªŒè¯ç çš„é‚®ä»¶

**é¢„æœŸé‚®ä»¶å†…å®¹**:
```
ç™»å½•éªŒè¯ç 

æ‚¨çš„éªŒè¯ç æ˜¯ï¼š

123456

æ­¤éªŒè¯ç å°†åœ¨ 5 åˆ†é’Ÿåè¿‡æœŸã€‚

å¦‚æœè¿™ä¸æ˜¯æ‚¨çš„æ“ä½œï¼Œè¯·å¿½ç•¥æ­¤é‚®ä»¶ã€‚
```

### 3. æµ‹è¯•éªŒè¯ç™»å½•
1. è¾“å…¥æ”¶åˆ°çš„6ä½éªŒè¯ç 
2. ç‚¹å‡»"éªŒè¯ç™»å½•"
3. åº”è¯¥æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°é¦–é¡µ

**æ£€æŸ¥ Console**:
```javascript
// æˆåŠŸçš„è¾“å‡º
Token verification successful
User logged in: { id: "...", email: "...", created_at: "..." }
```

**æ£€æŸ¥ localStorage**:
```javascript
localStorage.getItem('auth_token')
// åº”è¯¥è¿”å›ä¸€ä¸ª JWT token å­—ç¬¦ä¸²
```

### 4. æµ‹è¯• Token éªŒè¯
1. åˆ·æ–°é¡µé¢ï¼ˆF5ï¼‰
2. åº”è¯¥ä¿æŒç™»å½•çŠ¶æ€
3. ä¸éœ€è¦é‡æ–°è¾“å…¥éªŒè¯ç 

### 5. æµ‹è¯•ç™»å‡º
1. ç‚¹å‡»ç™»å‡ºæŒ‰é’®
2. åº”è¯¥æ¸…é™¤ token
3. è·³è½¬åˆ°ç™»å½•é¡µé¢

---

## ğŸ” æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: éªŒè¯ç å‘é€å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: "é‚®ä»¶æœåŠ¡æœªé…ç½®" æˆ– "é‚®ä»¶å‘é€å¤±è´¥"

**åŸå› **: Resend API Key æœªé…ç½®æˆ–æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Supabase Secrets ä¸­çš„ `RESEND_API_KEY`
2. ç¡®ä¿ API Key ä»¥ `re_` å¼€å¤´
3. ç¡®ä¿ API Key æœ‰ "Sending access" æƒé™
4. é‡æ–°éƒ¨ç½² Edge Functionï¼ˆå¦‚æœåˆšæ›´æ–°äº† Secretï¼‰

### é—®é¢˜ 2: éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ

**é”™è¯¯ä¿¡æ¯**: "éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ"

**å¯èƒ½åŸå› **:
1. éªŒè¯ç è¾“å…¥é”™è¯¯
2. éªŒè¯ç å·²ä½¿ç”¨è¿‡
3. è¶…è¿‡5åˆ†é’Ÿè¿‡æœŸæ—¶é—´
4. æ•°æ®åº“ä¸­æ²¡æœ‰å¯¹åº”è®°å½•

**è§£å†³æ–¹æ¡ˆ**:
1. é‡æ–°å‘é€éªŒè¯ç 
2. ç¡®ä¿åœ¨5åˆ†é’Ÿå†…ä½¿ç”¨
3. æ£€æŸ¥ `verification_codes` è¡¨:
   ```sql
   SELECT * FROM verification_codes 
   WHERE email = 'your@email.com' 
   ORDER BY created_at DESC 
   LIMIT 5;
   ```

### é—®é¢˜ 3: JWT é…ç½®é”™è¯¯

**é”™è¯¯ä¿¡æ¯**: "JWTé…ç½®é”™è¯¯"

**åŸå› **: JWT_SECRET æœªé…ç½®

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ Supabase Secrets ä¸­çš„ `JWT_SECRET`
2. ç¡®ä¿è‡³å°‘32ä¸ªå­—ç¬¦
3. é‡æ–°éƒ¨ç½² Edge Function

### é—®é¢˜ 4: ç”¨æˆ·åˆ›å»ºå¤±è´¥

**é”™è¯¯ä¿¡æ¯**: "ç”¨æˆ·åˆ›å»ºå¤±è´¥"

**åŸå› **: æ•°æ®åº“æƒé™æˆ–è¡¨ç»“æ„é—®é¢˜

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `users` è¡¨æ˜¯å¦å­˜åœ¨:
   ```sql
   SELECT * FROM information_schema.tables 
   WHERE table_name = 'users';
   ```

2. æ£€æŸ¥è¡¨ç»“æ„:
   ```sql
   SELECT column_name, data_type 
   FROM information_schema.columns 
   WHERE table_name = 'users';
   ```

3. ç¡®ä¿ RLS å·²ç¦ç”¨:
   ```sql
   ALTER TABLE users DISABLE ROW LEVEL SECURITY;
   ```

### é—®é¢˜ 5: Token éªŒè¯å¤±è´¥

**é”™è¯¯ä¿¡æ¯**: "ä»¤ç‰Œæ— æ•ˆæˆ–å·²è¿‡æœŸ"

**å¯èƒ½åŸå› **:
1. Token å·²è¿‡æœŸï¼ˆ30å¤©åï¼‰
2. JWT_SECRET å·²æ›´æ”¹
3. Token æ ¼å¼é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ¸…é™¤ localStorage å¹¶é‡æ–°ç™»å½•:
   ```javascript
   localStorage.removeItem('auth_token');
   ```

2. æ£€æŸ¥ token æ ¼å¼:
   ```javascript
   const token = localStorage.getItem('auth_token');
   console.log(token);
   // åº”è¯¥æ˜¯ä¸‰æ®µå¼: header.payload.signature
   ```

---

## ğŸ“ æ•°æ®åº“è¡¨ç»“æ„

### users è¡¨
```sql
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text UNIQUE NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### verification_codes è¡¨
```sql
CREATE TABLE verification_codes (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text NOT NULL,
  code text NOT NULL,
  expires_at timestamptz NOT NULL,
  used boolean DEFAULT false,
  created_at timestamptz DEFAULT now()
);
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

### å¿…é¡»å®Œæˆ
- [ ] é…ç½® Resend API Key
- [ ] æ›´æ¢ JWT Secretï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] æµ‹è¯•å®Œæ•´ç™»å½•æµç¨‹

### å¯é€‰ä¼˜åŒ–
- [ ] é…ç½®è‡ªå®šä¹‰é‚®ä»¶åŸŸå
- [ ] è‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿æ ·å¼
- [ ] æ·»åŠ é‚®ä»¶å‘é€å¤±è´¥é‡è¯•æœºåˆ¶
- [ ] æ·»åŠ éªŒè¯ç å‘é€é¢‘ç‡é™åˆ¶
- [ ] æ·»åŠ  IP åœ°å€è®°å½•å’Œé™åˆ¶

---

## ğŸ’¡ ä¸ Supabase Auth çš„å¯¹æ¯”

### Supabase Authï¼ˆæ—§ç³»ç»Ÿï¼‰
- âœ… å¼€ç®±å³ç”¨
- âœ… è‡ªåŠ¨å¤„ç†é‚®ä»¶å‘é€
- âŒ ä¾èµ– Supabase Auth æœåŠ¡
- âŒ ä½¿ç”¨ `auth.users` è¡¨
- âŒ éœ€è¦é¢å¤–çš„ profiles è¡¨
- âŒ è¾ƒå°‘çš„è‡ªå®šä¹‰ç©ºé—´

### è‡ªå®šä¹‰ JWT Authï¼ˆæ–°ç³»ç»Ÿï¼‰
- âœ… å®Œå…¨æ§åˆ¶è®¤è¯æµç¨‹
- âœ… ä½¿ç”¨è‡ªå·±çš„ users è¡¨
- âœ… ä¸ä¾èµ– Supabase Auth
- âœ… å¯ä»¥è‡ªå®šä¹‰é‚®ä»¶å†…å®¹å’Œæ ·å¼
- âœ… å¯ä»¥æ·»åŠ è‡ªå®šä¹‰éªŒè¯é€»è¾‘
- âŒ éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡ï¼ˆResendï¼‰
- âŒ éœ€è¦è‡ªå·±ç®¡ç† JWT Secret

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯:

1. **é”™è¯¯ä¿¡æ¯**
   - æµè§ˆå™¨ Console ä¸­çš„é”™è¯¯
   - Network è¯·æ±‚çš„å“åº”

2. **é…ç½®çŠ¶æ€**
   - Resend API Key æ˜¯å¦å·²é…ç½®
   - JWT Secret æ˜¯å¦å·²é…ç½®

3. **æ•°æ®åº“çŠ¶æ€**
   - users è¡¨æ˜¯å¦å­˜åœ¨
   - verification_codes è¡¨æ˜¯å¦å­˜åœ¨

4. **æµ‹è¯•æ­¥éª¤**
   - æ‚¨æ‰§è¡Œäº†å“ªäº›æ“ä½œ
   - åœ¨å“ªä¸€æ­¥å¤±è´¥äº†

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ä½¿ç”¨å‰ï¼Œè¯·ç¡®è®¤:

- [ ] Resend API Key å·²é…ç½®
- [ ] JWT Secret å·²é…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒéœ€æ›´æ¢ï¼‰
- [ ] Edge Functions å·²éƒ¨ç½²ï¼ˆ3ä¸ªï¼‰
- [ ] å‰ç«¯ä»£ç å·²æ›´æ–°
- [ ] ä»£ç æ£€æŸ¥é€šè¿‡ï¼ˆ0 errorsï¼‰
- [ ] æµ‹è¯•å‘é€éªŒè¯ç æˆåŠŸ
- [ ] æµ‹è¯•éªŒè¯ç™»å½•æˆåŠŸ
- [ ] æµ‹è¯• token éªŒè¯æˆåŠŸ
- [ ] æµ‹è¯•ç™»å‡ºåŠŸèƒ½æ­£å¸¸

**å¦‚æœä»¥ä¸Šéƒ½å®Œæˆ â†’ æ­å–œï¼è®¤è¯ç³»ç»Ÿå·²å®Œå…¨åˆ‡æ¢ï¼** ğŸ‰

---

## ğŸ¯ å¿«é€Ÿå¼€å§‹

**ç°åœ¨å°±å»é…ç½® Resend API Keyï¼š**

1. è®¿é—®: https://resend.com
2. æ³¨å†Œå¹¶åˆ›å»º API Key
3. åœ¨ Supabase Dashboard ä¸­é…ç½®
4. æµ‹è¯•ç™»å½•åŠŸèƒ½

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸš€
