# ç®¡ç†å‘˜è‡ªåŠ¨åˆ†é…è¯´æ˜

## ğŸ“‹ é…ç½®æ¦‚è¿°

ç³»ç»Ÿå·²é…ç½®è‡ªåŠ¨ç®¡ç†å‘˜åˆ†é…åŠŸèƒ½ï¼ŒæŒ‡å®šé‚®ç®±æ³¨å†Œåå°†è‡ªåŠ¨è·å¾—ç®¡ç†å‘˜æƒé™ã€‚

---

## âœ… å½“å‰é…ç½®

### ç®¡ç†å‘˜é‚®ç®±
```
1062250152@qq.com
```

### è‡ªåŠ¨åˆ†é…è§„åˆ™
- âœ… ä½¿ç”¨ `1062250152@qq.com` æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜
- âŒ å…¶ä»–é‚®ç®±æ³¨å†Œæ—¶ï¼Œé»˜è®¤ä¸ºæ™®é€šç”¨æˆ·
- âœ… ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æå‡å…¶ä»–ç”¨æˆ·ä¸ºç®¡ç†å‘˜

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®åº“é…ç½®

#### system_config è¡¨
```sql
config_key: 'admin_email'
config_value: '1062250152@qq.com'
```

#### è‡ªåŠ¨åˆ†é…è§¦å‘å™¨
```sql
-- è§¦å‘å™¨å‡½æ•°
CREATE FUNCTION auto_assign_admin_role()
RETURNS TRIGGER AS $$
DECLARE
  admin_email_config TEXT;
BEGIN
  -- ä»é…ç½®è¡¨è·å–ç®¡ç†å‘˜é‚®ç®±
  SELECT config_value INTO admin_email_config
  FROM system_config
  WHERE config_key = 'admin_email';
  
  -- å¦‚æœæ³¨å†Œé‚®ç®±åŒ¹é…ç®¡ç†å‘˜é‚®ç®±ï¼Œè‡ªåŠ¨è®¾ç½®ä¸ºç®¡ç†å‘˜
  IF LOWER(NEW.email) = LOWER(admin_email_config) THEN
    NEW.role := 'admin'::user_role;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- è§¦å‘å™¨
CREATE TRIGGER trigger_auto_assign_admin_role
  BEFORE INSERT ON profiles
  FOR EACH ROW
  EXECUTE FUNCTION auto_assign_admin_role();
```

### 2. ç¯å¢ƒå˜é‡é…ç½®

**.env æ–‡ä»¶**
```env
VITE_ADMIN_EMAIL=1062250152@qq.com
```

---

## ğŸ¯ ä½¿ç”¨æµç¨‹

### ç®¡ç†å‘˜æ³¨å†Œæµç¨‹

1. **è®¿é—®ç³»ç»Ÿ**
   - æ‰“å¼€åº”ç”¨é¦–é¡µ
   - ç‚¹å‡»"ç™»å½•"æŒ‰é’®

2. **ä½¿ç”¨ç®¡ç†å‘˜é‚®ç®±ç™»å½•**
   ```
   é‚®ç®±: 1062250152@qq.com
   ```

3. **æ¥æ”¶éªŒè¯ç **
   - ç³»ç»Ÿå‘é€ 6 ä½æ•°å­—éªŒè¯ç åˆ°é‚®ç®±
   - éªŒè¯ç æœ‰æ•ˆæœŸ 5 åˆ†é’Ÿ

4. **è¾“å…¥éªŒè¯ç **
   - è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç 
   - ç‚¹å‡»"éªŒè¯"

5. **è‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜**
   - âœ… ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«ç®¡ç†å‘˜é‚®ç®±
   - âœ… è‡ªåŠ¨åˆ†é…ç®¡ç†å‘˜æƒé™
   - âœ… å¯ä»¥çœ‹åˆ°"ç®¡ç†å‘˜åå°"æŒ‰é’®

### æ™®é€šç”¨æˆ·æ³¨å†Œæµç¨‹

1. **ä½¿ç”¨å…¶ä»–é‚®ç®±ç™»å½•**
   ```
   é‚®ç®±: user@example.com (ä»»ä½•éç®¡ç†å‘˜é‚®ç®±)
   ```

2. **å®ŒæˆéªŒè¯**
   - è¾“å…¥éªŒè¯ç 
   - æˆåŠŸç™»å½•

3. **é»˜è®¤ä¸ºæ™®é€šç”¨æˆ·**
   - âŒ æ²¡æœ‰ç®¡ç†å‘˜æƒé™
   - âŒ çœ‹ä¸åˆ°"ç®¡ç†å‘˜åå°"æŒ‰é’®
   - âœ… å¯ä»¥æ­£å¸¸ä½¿ç”¨æµ‹è¯„åŠŸèƒ½

---

## ğŸ‘¥ ç®¡ç†å‘˜æƒé™ç®¡ç†

### æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·
```sql
SELECT 
  email as "é‚®ç®±",
  role as "è§’è‰²",
  created_at as "æ³¨å†Œæ—¶é—´"
FROM profiles
ORDER BY created_at DESC;
```

### æ‰‹åŠ¨æå‡ç”¨æˆ·ä¸ºç®¡ç†å‘˜
```sql
-- æ–¹å¼1: é€šè¿‡é‚®ç®±
UPDATE profiles 
SET role = 'admin'::user_role 
WHERE email = 'user@example.com';

-- æ–¹å¼2: é€šè¿‡ç”¨æˆ·ID
UPDATE profiles 
SET role = 'admin'::user_role 
WHERE id = 'user-uuid-here';
```

### é™çº§ç®¡ç†å‘˜ä¸ºæ™®é€šç”¨æˆ·
```sql
UPDATE profiles 
SET role = 'user'::user_role 
WHERE email = 'user@example.com';
```

### æŸ¥çœ‹æ‰€æœ‰ç®¡ç†å‘˜
```sql
SELECT 
  email as "é‚®ç®±",
  created_at as "æ³¨å†Œæ—¶é—´"
FROM profiles
WHERE role = 'admin'
ORDER BY created_at;
```

---

## ğŸ” éªŒè¯é…ç½®

### 1. æ£€æŸ¥ç®¡ç†å‘˜é‚®ç®±é…ç½®
```sql
SELECT 
  config_key as "é…ç½®é¡¹",
  config_value as "é…ç½®å€¼",
  description as "è¯´æ˜"
FROM system_config 
WHERE config_key = 'admin_email';
```

**é¢„æœŸç»“æœ**:
```
é…ç½®é¡¹        | é…ç½®å€¼                | è¯´æ˜
-------------|----------------------|------------------
admin_email  | 1062250152@qq.com    | ç®¡ç†å‘˜é‚®ç®±é…ç½®
```

### 2. æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦å­˜åœ¨
```sql
SELECT 
  trigger_name as "è§¦å‘å™¨åç§°",
  event_manipulation as "è§¦å‘äº‹ä»¶",
  event_object_table as "ç›®æ ‡è¡¨"
FROM information_schema.triggers
WHERE trigger_name = 'trigger_auto_assign_admin_role';
```

**é¢„æœŸç»“æœ**:
```
è§¦å‘å™¨åç§°                        | è§¦å‘äº‹ä»¶ | ç›®æ ‡è¡¨
--------------------------------|---------|--------
trigger_auto_assign_admin_role  | INSERT  | profiles
```

### 3. æµ‹è¯•è‡ªåŠ¨åˆ†é…åŠŸèƒ½

**æ­¥éª¤**:
1. ä½¿ç”¨ `1062250152@qq.com` æ³¨å†Œ
2. å®ŒæˆéªŒè¯ç éªŒè¯
3. æ£€æŸ¥ç”¨æˆ·è§’è‰²

```sql
SELECT 
  email,
  role,
  CASE 
    WHEN role = 'admin' THEN 'âœ… ç®¡ç†å‘˜'
    ELSE 'âŒ æ™®é€šç”¨æˆ·'
  END as "æƒé™çŠ¶æ€"
FROM profiles 
WHERE email = '1062250152@qq.com';
```

**é¢„æœŸç»“æœ**:
```
email                | role  | æƒé™çŠ¶æ€
--------------------|-------|----------
1062250152@qq.com   | admin | âœ… ç®¡ç†å‘˜
```

---

## âš™ï¸ ä¿®æ”¹ç®¡ç†å‘˜é‚®ç®±

### æ–¹å¼ä¸€ï¼šé€šè¿‡ SQL ä¿®æ”¹

```sql
-- æ›´æ–°ç®¡ç†å‘˜é‚®ç®±é…ç½®
UPDATE system_config 
SET config_value = 'new-admin@example.com'
WHERE config_key = 'admin_email';

-- éªŒè¯ä¿®æ”¹
SELECT config_value 
FROM system_config 
WHERE config_key = 'admin_email';
```

### æ–¹å¼äºŒï¼šé€šè¿‡ç³»ç»Ÿè®¾ç½®ï¼ˆæœªæ¥åŠŸèƒ½ï¼‰

ç›®å‰éœ€è¦é€šè¿‡ SQL ä¿®æ”¹ï¼Œæœªæ¥ç‰ˆæœ¬å°†åœ¨ç®¡ç†å‘˜åå°æä¾›ç•Œé¢æ“ä½œã€‚

### æ³¨æ„äº‹é¡¹

âš ï¸ **é‡è¦æç¤º**:
1. ä¿®æ”¹ç®¡ç†å‘˜é‚®ç®±åï¼Œæ–°é‚®ç®±æ³¨å†Œæ—¶æ‰ä¼šè‡ªåŠ¨æˆä¸ºç®¡ç†å‘˜
2. å·²æ³¨å†Œçš„æ—§ç®¡ç†å‘˜é‚®ç®±ä¸ä¼šè‡ªåŠ¨å¤±å»æƒé™
3. å¦‚éœ€æ’¤é”€æ—§ç®¡ç†å‘˜æƒé™ï¼Œéœ€è¦æ‰‹åŠ¨é™çº§

**å®Œæ•´æ›´æ¢æµç¨‹**:
```sql
-- æ­¥éª¤1: æ›´æ–°ç®¡ç†å‘˜é‚®ç®±é…ç½®
UPDATE system_config 
SET config_value = 'new-admin@example.com'
WHERE config_key = 'admin_email';

-- æ­¥éª¤2: é™çº§æ—§ç®¡ç†å‘˜ï¼ˆå¯é€‰ï¼‰
UPDATE profiles 
SET role = 'user'::user_role 
WHERE email = '1062250152@qq.com';

-- æ­¥éª¤3: æå‡æ–°ç®¡ç†å‘˜ï¼ˆå¦‚æœå·²æ³¨å†Œï¼‰
UPDATE profiles 
SET role = 'admin'::user_role 
WHERE email = 'new-admin@example.com';
```

---

## ğŸ”’ å®‰å…¨è¯´æ˜

### è‡ªåŠ¨åˆ†é…æœºåˆ¶

1. **é‚®ç®±åŒ¹é…**
   - ä¸åŒºåˆ†å¤§å°å†™
   - `1062250152@qq.com` å’Œ `1062250152@QQ.COM` éƒ½ä¼šè¢«è¯†åˆ«

2. **è§¦å‘æ—¶æœº**
   - ä»…åœ¨ç”¨æˆ·é¦–æ¬¡æ³¨å†Œæ—¶è§¦å‘
   - å·²å­˜åœ¨çš„ç”¨æˆ·ä¸ä¼šè¢«è‡ªåŠ¨ä¿®æ”¹

3. **æƒé™ä¿æŠ¤**
   - è§¦å‘å™¨ä½¿ç”¨ `SECURITY DEFINER` ç¡®ä¿æƒé™æ­£ç¡®
   - æ™®é€šç”¨æˆ·æ— æ³•ç»•è¿‡è§¦å‘å™¨è·å–ç®¡ç†å‘˜æƒé™

### æœ€ä½³å®è·µ

1. **å®šæœŸå®¡æŸ¥ç®¡ç†å‘˜**
   ```sql
   -- æŸ¥çœ‹æ‰€æœ‰ç®¡ç†å‘˜åŠå…¶æ³¨å†Œæ—¶é—´
   SELECT 
     email,
     created_at,
     updated_at
   FROM profiles
   WHERE role = 'admin'
   ORDER BY created_at;
   ```

2. **è®°å½•æƒé™å˜æ›´**
   ```sql
   -- æŸ¥çœ‹ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
   SELECT 
     action,
     details,
     created_at
   FROM admin_logs
   WHERE action = 'update_user_role'
   ORDER BY created_at DESC
   LIMIT 20;
   ```

3. **å¤‡ä»½ç®¡ç†å‘˜åˆ—è¡¨**
   ```sql
   -- å¯¼å‡ºç®¡ç†å‘˜åˆ—è¡¨
   COPY (
     SELECT email, role, created_at 
     FROM profiles 
     WHERE role = 'admin'
   ) TO '/tmp/admin_backup.csv' CSV HEADER;
   ```

---

## ğŸ“Š å¸¸è§åœºæ™¯

### åœºæ™¯1: é¦–æ¬¡éƒ¨ç½²ç³»ç»Ÿ

**æ“ä½œæ­¥éª¤**:
1. ç¡®è®¤ç®¡ç†å‘˜é‚®ç®±é…ç½®æ­£ç¡®
   ```sql
   SELECT config_value FROM system_config WHERE config_key = 'admin_email';
   ```

2. ä½¿ç”¨ç®¡ç†å‘˜é‚®ç®±æ³¨å†Œ
   - è®¿é—®ç³»ç»Ÿ
   - ä½¿ç”¨ `1062250152@qq.com` ç™»å½•
   - å®ŒæˆéªŒè¯

3. éªŒè¯ç®¡ç†å‘˜æƒé™
   - åˆ·æ–°é¡µé¢
   - æŸ¥çœ‹æ˜¯å¦æ˜¾ç¤º"ç®¡ç†å‘˜åå°"æŒ‰é’®

### åœºæ™¯2: æ·»åŠ é¢å¤–ç®¡ç†å‘˜

**æ“ä½œæ­¥éª¤**:
1. è®©æ–°ç®¡ç†å‘˜å…ˆæ³¨å†Œè´¦å·
   - ä½¿ç”¨ä»»æ„é‚®ç®±æ³¨å†Œ
   - å®ŒæˆéªŒè¯ç éªŒè¯

2. ä¸»ç®¡ç†å‘˜æå‡æƒé™
   ```sql
   UPDATE profiles 
   SET role = 'admin'::user_role 
   WHERE email = 'new-admin@example.com';
   ```

3. é€šçŸ¥æ–°ç®¡ç†å‘˜
   - è®©æ–°ç®¡ç†å‘˜åˆ·æ–°é¡µé¢
   - ç¡®è®¤å¯ä»¥çœ‹åˆ°"ç®¡ç†å‘˜åå°"

### åœºæ™¯3: ç§»é™¤ç®¡ç†å‘˜æƒé™

**æ“ä½œæ­¥éª¤**:
1. ç¡®è®¤è¦ç§»é™¤çš„ç®¡ç†å‘˜é‚®ç®±
   ```sql
   SELECT email, role FROM profiles WHERE role = 'admin';
   ```

2. é™çº§ä¸ºæ™®é€šç”¨æˆ·
   ```sql
   UPDATE profiles 
   SET role = 'user'::user_role 
   WHERE email = 'old-admin@example.com';
   ```

3. éªŒè¯æƒé™å·²ç§»é™¤
   ```sql
   SELECT email, role FROM profiles WHERE email = 'old-admin@example.com';
   ```

### åœºæ™¯4: æ›´æ¢ä¸»ç®¡ç†å‘˜é‚®ç®±

**æ“ä½œæ­¥éª¤**:
1. æ›´æ–°é…ç½®
   ```sql
   UPDATE system_config 
   SET config_value = 'new-primary-admin@example.com'
   WHERE config_key = 'admin_email';
   ```

2. å¦‚æœæ–°ç®¡ç†å‘˜å·²æ³¨å†Œï¼Œæ‰‹åŠ¨æå‡
   ```sql
   UPDATE profiles 
   SET role = 'admin'::user_role 
   WHERE email = 'new-primary-admin@example.com';
   ```

3. å¯é€‰ï¼šä¿ç•™æˆ–ç§»é™¤æ—§ç®¡ç†å‘˜æƒé™
   ```sql
   -- ä¿ç•™æ—§ç®¡ç†å‘˜ï¼ˆæ¨èï¼‰
   -- æ— éœ€æ“ä½œ
   
   -- æˆ–ç§»é™¤æ—§ç®¡ç†å‘˜
   UPDATE profiles 
   SET role = 'user'::user_role 
   WHERE email = '1062250152@qq.com';
   ```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: ç®¡ç†å‘˜é‚®ç®±æ³¨å†Œåæ²¡æœ‰ç®¡ç†å‘˜æƒé™

**æ£€æŸ¥æ­¥éª¤**:

1. ç¡®è®¤é‚®ç®±é…ç½®
   ```sql
   SELECT config_value FROM system_config WHERE config_key = 'admin_email';
   ```

2. ç¡®è®¤è§¦å‘å™¨å­˜åœ¨
   ```sql
   SELECT trigger_name 
   FROM information_schema.triggers 
   WHERE trigger_name = 'trigger_auto_assign_admin_role';
   ```

3. æ‰‹åŠ¨åˆ†é…æƒé™
   ```sql
   UPDATE profiles 
   SET role = 'admin'::user_role 
   WHERE email = '1062250152@qq.com';
   ```

### é—®é¢˜2: è§¦å‘å™¨ä¸å·¥ä½œ

**è§£å†³æ–¹æ¡ˆ**:

1. é‡æ–°åˆ›å»ºè§¦å‘å™¨
   ```sql
   -- åˆ é™¤æ—§è§¦å‘å™¨
   DROP TRIGGER IF EXISTS trigger_auto_assign_admin_role ON profiles;
   
   -- é‡æ–°åˆ›å»º
   CREATE TRIGGER trigger_auto_assign_admin_role
     BEFORE INSERT ON profiles
     FOR EACH ROW
     EXECUTE FUNCTION auto_assign_admin_role();
   ```

2. æµ‹è¯•è§¦å‘å™¨
   ```sql
   -- æŸ¥çœ‹è§¦å‘å™¨çŠ¶æ€
   SELECT * FROM information_schema.triggers 
   WHERE trigger_name = 'trigger_auto_assign_admin_role';
   ```

### é—®é¢˜3: æ— æ³•çœ‹åˆ°ç®¡ç†å‘˜åå°

**æ£€æŸ¥æ­¥éª¤**:

1. ç¡®è®¤ç”¨æˆ·è§’è‰²
   ```sql
   SELECT email, role FROM profiles WHERE email = '1062250152@qq.com';
   ```

2. å¦‚æœè§’è‰²ä¸æ˜¯ adminï¼Œæ‰‹åŠ¨æ›´æ–°
   ```sql
   UPDATE profiles 
   SET role = 'admin'::user_role 
   WHERE email = '1062250152@qq.com';
   ```

3. åˆ·æ–°æµè§ˆå™¨é¡µé¢ï¼ˆF5ï¼‰

---

## ğŸ“ ç»´æŠ¤å»ºè®®

### å®šæœŸæ£€æŸ¥

**æ¯æœˆæ£€æŸ¥æ¸…å•**:
- [ ] æŸ¥çœ‹ç®¡ç†å‘˜åˆ—è¡¨
- [ ] ç¡®è®¤ç®¡ç†å‘˜é‚®ç®±é…ç½®æ­£ç¡®
- [ ] æ£€æŸ¥è§¦å‘å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
- [ ] å®¡æŸ¥ç®¡ç†å‘˜æ“ä½œæ—¥å¿—

**æ£€æŸ¥è„šæœ¬**:
```sql
-- å®Œæ•´ç³»ç»Ÿæ£€æŸ¥
SELECT '=== ç®¡ç†å‘˜é‚®ç®±é…ç½® ===' as "æ£€æŸ¥é¡¹";
SELECT config_key, config_value FROM system_config WHERE config_key = 'admin_email';

SELECT '=== å½“å‰ç®¡ç†å‘˜åˆ—è¡¨ ===' as "æ£€æŸ¥é¡¹";
SELECT email, created_at FROM profiles WHERE role = 'admin' ORDER BY created_at;

SELECT '=== è§¦å‘å™¨çŠ¶æ€ ===' as "æ£€æŸ¥é¡¹";
SELECT trigger_name, event_manipulation, event_object_table 
FROM information_schema.triggers 
WHERE trigger_name = 'trigger_auto_assign_admin_role';

SELECT '=== æœ€è¿‘ç®¡ç†å‘˜æ“ä½œ ===' as "æ£€æŸ¥é¡¹";
SELECT action, created_at FROM admin_logs 
WHERE action LIKE '%admin%' OR action LIKE '%role%'
ORDER BY created_at DESC LIMIT 10;
```

### å¤‡ä»½å»ºè®®

**å®šæœŸå¤‡ä»½**:
```sql
-- å¤‡ä»½ç®¡ç†å‘˜é…ç½®
SELECT * FROM system_config WHERE config_key = 'admin_email';

-- å¤‡ä»½ç®¡ç†å‘˜åˆ—è¡¨
SELECT email, role, created_at, updated_at 
FROM profiles 
WHERE role = 'admin';
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### å¿«é€Ÿå‘½ä»¤å‚è€ƒ

```sql
-- æŸ¥çœ‹ç®¡ç†å‘˜é‚®ç®±
SELECT config_value FROM system_config WHERE config_key = 'admin_email';

-- æŸ¥çœ‹æ‰€æœ‰ç®¡ç†å‘˜
SELECT email, role FROM profiles WHERE role = 'admin';

-- æ·»åŠ ç®¡ç†å‘˜
UPDATE profiles SET role = 'admin'::user_role WHERE email = 'user@example.com';

-- ç§»é™¤ç®¡ç†å‘˜
UPDATE profiles SET role = 'user'::user_role WHERE email = 'user@example.com';

-- æ›´æ–°ç®¡ç†å‘˜é‚®ç®±é…ç½®
UPDATE system_config SET config_value = 'new-admin@example.com' WHERE config_key = 'admin_email';
```

### ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå¼€å§‹.md](./å¿«é€Ÿå¼€å§‹.md) - ç³»ç»Ÿå¿«é€Ÿæµ‹è¯•æŒ‡å—
- [éƒ¨ç½²æµ‹è¯•å®Œæ•´æŒ‡å—.md](./éƒ¨ç½²æµ‹è¯•å®Œæ•´æŒ‡å—.md) - å®Œæ•´éƒ¨ç½²è¯´æ˜
- [docs/ADMIN_SETUP.md](./docs/ADMIN_SETUP.md) - ç®¡ç†å‘˜è®¾ç½®æŒ‡å—

---

## âœ… é…ç½®æ£€æŸ¥æ¸…å•

- [x] ç®¡ç†å‘˜é‚®ç®±å·²è®¾ç½®ä¸º `1062250152@qq.com`
- [x] è‡ªåŠ¨åˆ†é…è§¦å‘å™¨å·²åˆ›å»º
- [x] .env æ–‡ä»¶å·²æ›´æ–°
- [x] æ•°æ®åº“è¿ç§»å·²æ‰§è¡Œ
- [ ] ä½¿ç”¨ç®¡ç†å‘˜é‚®ç®±æµ‹è¯•æ³¨å†Œï¼ˆå¾…æµ‹è¯•ï¼‰
- [ ] éªŒè¯è‡ªåŠ¨è·å¾—ç®¡ç†å‘˜æƒé™ï¼ˆå¾…æµ‹è¯•ï¼‰

---

**é…ç½®å®Œæˆæ—¶é—´**: 2025-01-10  
**ç®¡ç†å‘˜é‚®ç®±**: 1062250152@qq.com  
**çŠ¶æ€**: âœ… å·²é…ç½®å¹¶ç”Ÿæ•ˆ
