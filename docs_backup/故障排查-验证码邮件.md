# 🔍 故障排查：验证码邮件问题

## 📋 问题描述

**症状**：修改了邮件模板后，仍然收到链接而不是6位数字验证码。

---

## 🎯 最可能的原因

### 原因1：修改了错误的模板 ⚠️⚠️⚠️

**这是最常见的问题！**

Supabase 有**多个**邮件模板，您必须修改正确的那个：

| 模板名称 | 何时使用 | 发送内容 |
|---------|---------|---------|
| **Confirm signup** ✅ | 用户注册/登录时 | **这个模板发送验证码** |
| Magic Link ❌ | 魔法链接登录 | 这个模板发送链接 |
| Invite user | 邀请用户 | 邀请链接 |
| Reset Password | 重置密码 | 重置链接 |

**您需要修改的是：Confirm signup**

---

## ✅ 正确配置步骤（请严格按照此步骤操作）

### 第1步：访问 Supabase Dashboard

1. 打开浏览器
2. 访问：https://supabase.com/dashboard
3. 登录您的账号
4. 选择项目：`zrfnnerdaijcmhlemqld`

### 第2步：进入邮件模板设置

1. 在左侧菜单中，点击 **"Authentication"**（认证）
2. 在子菜单中，点击 **"Email Templates"**（邮件模板）

或者直接访问：
```
https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/auth/templates
```

### 第3步：找到正确的模板

在邮件模板列表中，您会看到多个模板：

```
📧 Email Templates

├── Confirm signup          ← ✅ 点击这个！
├── Invite user
├── Magic Link             ← ❌ 不要点这个！
├── Change Email Address
└── Reset Password
```

**重要**：点击 **"Confirm signup"**（不是 "Magic Link"）

### 第4步：确认您打开了正确的模板

点击进入后，页面顶部应该显示：

```
Email Templates > Confirm signup
```

如果显示的是其他名称（如 "Magic Link"），请返回上一步，重新选择。

### 第5步：查看当前模板内容

在编辑器中，您可能会看到类似这样的内容：

```html
<h2>Confirm your signup</h2>
<p>Follow this link to confirm your user:</p>
<p><a href="{{ .ConfirmationURL }}">Confirm your mail</a></p>
```

或者：

```html
<h2>Confirm your signup</h2>
<p>Enter this code: {{ .Token }}</p>
```

### 第6步：替换模板内容

1. **选中所有内容**（Ctrl+A 或 Cmd+A）
2. **删除**（Delete 或 Backspace）
3. **粘贴**以下新内容：

```html
<h2>确认您的邮箱</h2>

<p>您好！</p>

<p>感谢您使用人格特质投资策略评估系统。</p>

<p>您的验证码是：</p>

<h1 style="font-size: 32px; font-weight: bold; color: #1DB954; letter-spacing: 5px; margin: 20px 0;">{{ .Token }}</h1>

<p>此验证码将在 <strong>5分钟</strong> 后过期。</p>

<p>如果您没有请求此验证码，请忽略此邮件。</p>

<hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

<p style="color: #666; font-size: 12px;">
  这是一封自动发送的邮件，请勿回复。<br>
  人格特质投资策略评估系统
</p>
```

### 第7步：保存模板

1. 向下滚动到页面底部
2. 点击 **"Save"** 按钮（绿色按钮）
3. 等待看到成功提示（通常是绿色的通知）

### 第8步：等待配置生效

**重要**：保存后不要立即测试！

1. 等待 **2-3 分钟**
2. 这段时间 Supabase 会更新配置

### 第9步：清除浏览器缓存

1. 打开浏览器设置
2. 清除缓存：
   - Chrome: Ctrl+Shift+Delete
   - Firefox: Ctrl+Shift+Delete
   - Safari: Cmd+Option+E
3. 选择"缓存的图片和文件"
4. 点击"清除数据"

### 第10步：测试

1. 访问应用登录页面
2. 输入邮箱：`1062250152@qq.com`
3. 点击"发送验证码"
4. 等待 30 秒到 1 分钟
5. 检查邮箱（包括垃圾邮件箱）

---

## 🔍 验证结果

### ✅ 成功的标志

收到的邮件应该是这样的：

```
主题: Confirm your signup

内容:
确认您的邮箱

您好！

感谢您使用人格特质投资策略评估系统。

您的验证码是：

123456

此验证码将在 5分钟 后过期。

如果您没有请求此验证码，请忽略此邮件。
```

### ❌ 失败的标志

如果收到的邮件是这样的，说明配置失败：

```
主题: Confirm your signup

内容:
Confirm your signup

Follow this link to confirm your user:
[Confirm your mail] (这是一个链接)
```

---

## 🐛 如果仍然收到链接

### 检查清单

请逐项确认：

#### 1. 确认修改了正确的模板

- [ ] 我访问了 Email Templates 页面
- [ ] 我点击的是 "Confirm signup" 模板
- [ ] 页面顶部显示 "Email Templates > Confirm signup"
- [ ] 我没有修改 "Magic Link" 模板

#### 2. 确认模板内容正确

- [ ] 模板中包含 `{{ .Token }}`
- [ ] 模板中不包含 `{{ .ConfirmationURL }}`
- [ ] 模板中不包含 `<a href=` 标签

#### 3. 确认保存成功

- [ ] 我点击了 "Save" 按钮
- [ ] 我看到了成功保存的提示
- [ ] 我等待了 2-3 分钟

#### 4. 确认测试正确

- [ ] 我清除了浏览器缓存
- [ ] 我使用了新的浏览器标签页
- [ ] 我等待了至少 30 秒才检查邮箱

---

## 🔧 高级故障排查

### 方法1：检查 Supabase Auth 设置

1. 访问：https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/settings/auth
2. 向下滚动到 "Email Auth" 部分
3. 确认以下设置：
   - ✅ "Enable email provider" 已启用
   - ✅ "Enable email confirmations" 已启用

### 方法2：查看 Auth 日志

1. 访问：https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/logs/auth-logs
2. 查找最近的登录尝试
3. 检查日志中的错误信息

### 方法3：重置模板

如果以上方法都不起作用：

1. 在 "Confirm signup" 模板编辑页面
2. 查找 "Reset to default" 按钮（如果有）
3. 点击重置
4. 然后重新粘贴新模板内容
5. 保存

### 方法4：检查邮件服务商

某些邮件服务商（如 QQ 邮箱、163 邮箱）可能会：
- 延迟接收邮件（可能需要 5-10 分钟）
- 将邮件放入垃圾邮件箱
- 修改邮件内容

**建议**：使用 Gmail 或其他国际邮箱测试。

---

## 📸 截图对比

### ✅ 正确的模板选择

```
Email Templates 页面应该显示：

┌─────────────────────────────────────┐
│ Email Templates                     │
├─────────────────────────────────────┤
│ ✅ Confirm signup      [Edit]       │  ← 点击这个
│    Invite user         [Edit]       │
│    Magic Link          [Edit]       │  ← 不要点这个
│    Change Email        [Edit]       │
│    Reset Password      [Edit]       │
└─────────────────────────────────────┘
```

### ✅ 正确的模板内容

编辑器中应该包含：

```html
{{ .Token }}  ← 必须有这个变量
```

不应该包含：

```html
{{ .ConfirmationURL }}  ← 不应该有这个
<a href="{{ .ConfirmationURL }}">  ← 不应该有这个
```

---

## 💡 常见误区

### 误区1：修改了 "Magic Link" 模板

**错误**：以为 "Magic Link" 就是发送验证码的模板  
**正确**：应该修改 "Confirm signup" 模板

### 误区2：没有等待配置生效

**错误**：保存后立即测试  
**正确**：保存后等待 2-3 分钟

### 误区3：没有清除缓存

**错误**：使用同一个浏览器标签页测试  
**正确**：清除缓存或使用新的隐私窗口

### 误区4：检查邮箱太快

**错误**：发送验证码后立即检查邮箱  
**正确**：等待 30 秒到 1 分钟

---

## 🎯 终极解决方案

如果您已经尝试了以上所有方法，仍然收到链接，请按照以下步骤操作：

### 步骤1：完全重置

1. 访问 Supabase Dashboard
2. 进入 Email Templates
3. 找到 "Confirm signup" 模板
4. 如果有 "Reset to default" 按钮，点击它
5. 等待重置完成

### 步骤2：重新配置

1. 再次打开 "Confirm signup" 模板
2. 复制以下**最简化**的模板：

```html
<h2>验证码</h2>
<p>您的验证码是：</p>
<h1>{{ .Token }}</h1>
<p>5分钟内有效</p>
```

3. 粘贴到编辑器
4. 保存

### 步骤3：等待并测试

1. 等待 5 分钟（不是 2-3 分钟）
2. 清除浏览器所有数据（不只是缓存）
3. 重启浏览器
4. 使用隐私/无痕模式访问应用
5. 测试发送验证码

---

## 📞 需要进一步帮助

如果问题仍然存在，请提供以下信息：

### 1. 模板信息
- 您修改的模板名称是什么？
- 模板编辑页面顶部显示什么？
- 模板内容中是否包含 `{{ .Token }}`？

### 2. 操作信息
- 您是否点击了 "Save" 按钮？
- 是否看到了保存成功的提示？
- 保存后等待了多长时间？

### 3. 测试信息
- 使用的邮箱地址是什么？
- 收到邮件的时间是什么时候？
- 邮件主题是什么？
- 邮件内容是什么？（可以截图）

### 4. 环境信息
- 使用的浏览器是什么？
- 是否清除了缓存？
- 是否使用了隐私/无痕模式？

---

## ✅ 成功案例

### 案例1：修改了错误的模板

**问题**：用户修改了 "Magic Link" 模板  
**解决**：修改 "Confirm signup" 模板后成功

### 案例2：没有等待配置生效

**问题**：保存后立即测试，仍然收到旧邮件  
**解决**：等待 3 分钟后重新测试，成功收到验证码

### 案例3：邮箱延迟

**问题**：使用 QQ 邮箱，10 分钟后才收到邮件  
**解决**：改用 Gmail，立即收到验证码

---

## 🎊 配置成功后

配置成功后，您将能够：

1. ✅ 收到包含6位数字验证码的邮件
2. ✅ 在登录页面输入验证码
3. ✅ 成功登录系统
4. ✅ 使用管理员邮箱自动获得管理员权限
5. ✅ 访问所有系统功能

---

**最后更新**: 2025-01-10  
**重要性**: ⭐⭐⭐⭐⭐（必须正确配置）

**请严格按照步骤操作，确保修改了正确的模板！** 🎯
