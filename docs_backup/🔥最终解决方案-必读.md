# 🔥 CORS 错误最终解决方案

## ⚠️ 重要提示

您看到的 CORS 错误是因为浏览器缓存了旧的环境变量。我已经完成了所有必要的代码修复。

## 🎯 问题根源

系统中存在两个 Supabase 项目：

### ❌ 旧项目（错误）
- URL: `https://zrfnnerdaijcmhlemqld.supabase.co`
- 状态: Edge Functions 未部署
- 结果: 404 错误 → CORS 失败

### ✅ 新项目（正确）
- URL: `https://ahgnspudsmrvsqcinxcj.supabase.co`
- 状态: 所有 Edge Functions 已部署并正常工作
- 结果: 返回正确的 CORS 头

## 🛠️ 已完成的修复

### 1. 更新环境变量
已将 `.env` 文件更新为正确的 Supabase 项目：

```env
VITE_SUPABASE_URL=https://ahgnspudsmrvsqcinxcj.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 2. 移除 Supabase Auth 依赖
创建了自定义认证辅助函数 `src/utils/auth.ts`，替代了所有 `supabase.auth` 调用：

- ✅ `getCurrentUser()` - 替代 `supabase.auth.getUser()`
- ✅ `getCurrentSession()` - 替代 `supabase.auth.getSession()`
- ✅ `getCurrentUserId()` - 获取当前用户 ID

### 3. 更新所有 API 文件
已更新以下文件以使用新的认证函数：

- ✅ `src/db/api.ts`
- ✅ `src/db/adminApi.ts`
- ✅ `src/db/giftCodeApi.ts`

### 4. Edge Functions 部署状态
所有 3 个 Edge Functions 已成功部署到正确的项目：

| 函数名 | 版本 | 状态 | 功能 |
|--------|------|------|------|
| send-verification-code | 3 | ✅ ACTIVE | 发送验证码 |
| verify-code-and-login | 3 | ✅ ACTIVE | 验证登录 |
| verify-token | 3 | ✅ ACTIVE | 验证令牌 |

### 5. CORS 配置验证
已通过 curl 测试验证 CORS 配置正确：

```bash
HTTP/2 204 ✅
access-control-allow-origin: * ✅
access-control-allow-headers: authorization, x-client-info, apikey, content-type ✅
access-control-allow-methods: POST, OPTIONS ✅
access-control-max-age: 86400 ✅
```

## 📋 您需要做的操作

### 步骤 1: 清除浏览器缓存 ⭐ 最重要！

浏览器缓存了旧的环境变量，必须清除才能加载新的配置。

#### 方法 A: 硬刷新（推荐）
- **Windows/Linux**: 按 `Ctrl + Shift + R`
- **Mac**: 按 `Cmd + Shift + R`

#### 方法 B: 完全清除缓存
1. 打开浏览器开发者工具（F12）
2. 右键点击刷新按钮
3. 选择"清空缓存并硬性重新加载"

#### 方法 C: 无痕模式测试
1. 打开无痕/隐私浏览窗口
2. 访问应用 URL
3. 测试登录功能

### 步骤 2: 验证环境变量已更新

打开浏览器控制台（F12），输入以下命令：

```javascript
console.log(import.meta.env.VITE_SUPABASE_URL)
```

**预期输出**:
```
https://ahgnspudsmrvsqcinxcj.supabase.co
```

**如果输出仍然是旧 URL**:
```
https://zrfnnerdaijcmhlemqld.supabase.co  ❌ 错误！
```

说明缓存未清除，请重复步骤 1。

### 步骤 3: 测试登录流程

#### 3.1 发送验证码
1. 输入邮箱地址
2. 点击"发送验证码"
3. **预期结果**:
   - ✅ 控制台没有 CORS 错误
   - ✅ 显示"验证码已发送到您的邮箱"
   - ✅ 按钮变为"重新发送 (60s)"

#### 3.2 接收验证码
1. 检查邮箱收件箱
2. 查找主题为"您的验证码"的邮件
3. 复制 6 位数验证码

**如果没收到邮件**:
- 检查垃圾邮件文件夹
- 等待 1-2 分钟
- 检查邮箱地址是否正确

#### 3.3 验证登录
1. 输入收到的 6 位验证码
2. 点击"验证登录"
3. **预期结果**:
   - ✅ 登录成功
   - ✅ 跳转到首页
   - ✅ 右上角显示用户邮箱

#### 3.4 验证持久登录
1. 刷新页面（F5）
2. **预期结果**:
   - ✅ 保持登录状态
   - ✅ 无需重新输入验证码

## 🐛 故障排除

### 问题 1: 仍然看到 CORS 错误

**症状**:
```
Access to fetch at 'https://zrfnnerdaijcmhlemqld.supabase.co/...' 
has been blocked by CORS policy
```

**原因**: 浏览器缓存未清除

**解决方案**:
1. 完全关闭浏览器（所有窗口和标签页）
2. 重新打开浏览器
3. 访问应用 URL
4. 按 `Ctrl + Shift + R` 硬刷新

### 问题 2: 看到 401 错误

**症状**:
```
Failed to load resource: the server responded with a status of 401
```

**原因**: 这是正常的！说明 CORS 已解决，现在是认证问题。

**解决方案**:
1. 清除 localStorage: 在控制台输入 `localStorage.clear()`
2. 刷新页面
3. 重新登录

### 问题 3: 验证码邮件未收到

**可能原因**:
1. Resend API Key 未配置或已过期
2. 邮箱地址错误
3. 邮件在垃圾邮件文件夹

**解决方案**:
1. 检查浏览器控制台是否有错误信息
2. 检查垃圾邮件文件夹
3. 尝试使用其他邮箱地址
4. 联系管理员检查 Resend API Key

### 问题 4: 环境变量未更新

**症状**: 控制台显示旧的 Supabase URL

**解决方案**:
1. 确认 `.env` 文件已更新
2. 重启开发服务器（如果在本地运行）
3. 等待 2-3 分钟让部署生效
4. 清除浏览器缓存

## 📊 验证清单

在报告问题之前，请确认以下所有项目：

- [ ] 已按 `Ctrl + Shift + R` 硬刷新页面
- [ ] 控制台显示正确的 Supabase URL (`ahgnspudsmrvsqcinxcj`)
- [ ] 浏览器控制台没有 CORS 错误
- [ ] 点击"发送验证码"后显示成功消息
- [ ] 检查了垃圾邮件文件夹
- [ ] 尝试了无痕模式

## 🔍 调试信息

如果问题仍然存在，请提供以下信息：

### 1. 浏览器控制台输出
打开控制台（F12），复制所有红色错误信息。

### 2. 网络请求详情
1. 打开开发者工具 → Network 标签
2. 点击"发送验证码"
3. 找到 `send-verification-code` 请求
4. 复制请求 URL 和响应状态码

### 3. 环境变量验证
在控制台运行：
```javascript
console.log({
  url: import.meta.env.VITE_SUPABASE_URL,
  key: import.meta.env.VITE_SUPABASE_ANON_KEY?.substring(0, 20) + '...'
})
```

## 📝 技术细节

### 认证流程

```
用户输入邮箱
    ↓
发送验证码 (send-verification-code)
    ↓
生成 6 位随机码 → 存储到数据库 → 发送邮件
    ↓
用户输入验证码
    ↓
验证登录 (verify-code-and-login)
    ↓
验证码校验 → 创建/获取用户 → 生成 JWT Token
    ↓
Token 存储到 localStorage
    ↓
页面刷新时验证 Token (verify-token)
    ↓
验证 JWT → 获取用户信息 → 恢复登录状态
```

### Edge Functions 配置

所有 Edge Functions 都配置了：

1. **CORS 头**:
   - `Access-Control-Allow-Origin: *`
   - `Access-Control-Allow-Methods: POST, OPTIONS`
   - `Access-Control-Max-Age: 86400`

2. **OPTIONS 处理**:
   - 返回 204 状态码
   - 包含所有必要的 CORS 头
   - 不执行业务逻辑

3. **错误处理**:
   - 统一的错误响应格式
   - 详细的错误日志
   - 用户友好的错误消息

### 前端请求方式

使用原生 `fetch()` API，避免 Supabase SDK 的自动 JWT 验证：

```typescript
const response = await fetch(
  `${SUPABASE_URL}/functions/v1/send-verification-code`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'apikey': SUPABASE_ANON_KEY,
    },
    body: JSON.stringify({ email }),
  }
);
```

## 🎉 成功标志

当您看到以下情况时，说明一切正常：

1. ✅ 浏览器控制台干净，没有错误
2. ✅ 点击"发送验证码"后显示绿色成功提示
3. ✅ 1-2 分钟内收到验证码邮件
4. ✅ 输入验证码后成功登录
5. ✅ 右上角显示用户邮箱地址
6. ✅ 刷新页面后保持登录状态
7. ✅ 可以正常访问所有功能

## 📞 需要帮助？

如果完成上述所有步骤后问题仍然存在，请提供：

1. 浏览器控制台的完整错误信息
2. Network 标签中的请求详情
3. 环境变量验证结果
4. 使用的浏览器和版本

---

**最后更新**: 2025-01-10

**状态**: ✅ 所有代码修复已完成，等待浏览器缓存清除

**关键操作**: 按 `Ctrl + Shift + R` 硬刷新页面！
