# DeepSeek AI 分析购买流程图

## 完整流程图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         用户完成测评                                  │
│                    (人格、金融、风险、交易)                            │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ResultPage 结果页面                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  基础测评报告（免费）                                          │   │
│  │  - 投资风格匹配                                                │   │
│  │  - 人格特质分析                                                │   │
│  │  - 数学金融能力                                                │   │
│  │  - 风险偏好分析                                                │   │
│  │  - 详细投资建议                                                │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  检查购买状态                                                  │   │
│  │  paymentApi.getCompletedOrderByTestResult(testId)            │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│              ┌──────────────┴──────────────┐                        │
│              │                              │                        │
│              ▼                              ▼                        │
│  ┌─────────────────────┐      ┌─────────────────────────┐          │
│  │  已购买              │      │  未购买                  │          │
│  │  显示分析报告        │      │  显示购买卡片            │          │
│  │  DeepSeekAnalysisCard│      │  PurchaseAnalysisCard   │          │
│  └─────────────────────┘      └───────────┬─────────────┘          │
│                                            │                         │
└────────────────────────────────────────────┼─────────────────────────┘
                                             │
                                             ▼
                              ┌──────────────────────────┐
                              │  用户点击购买按钮         │
                              └──────────┬───────────────┘
                                         │
                                         ▼
                    ┌────────────────────────────────────────┐
                    │  调用 paymentApi.createCheckoutSession │
                    │  创建支付会话                           │
                    └──────────┬─────────────────────────────┘
                               │
                               ▼
                    ┌────────────────────────────────────────┐
                    │  Edge Function: create_stripe_checkout │
                    │  1. 创建订单记录 (status: pending)      │
                    │  2. 调用 Stripe API                     │
                    │  3. 返回支付 URL                        │
                    └──────────┬─────────────────────────────┘
                               │
                               ▼
                    ┌────────────────────────────────────────┐
                    │  在新窗口打开 Stripe 支付页面           │
                    │  window.open(result.url, '_blank')     │
                    └──────────┬─────────────────────────────┘
                               │
                               ▼
                    ┌────────────────────────────────────────┐
                    │  用户在 Stripe 页面完成支付             │
                    │  - 输入卡号信息                         │
                    │  - 确认支付                             │
                    └──────────┬─────────────────────────────┘
                               │
                ┌──────────────┴──────────────┐
                │                              │
                ▼                              ▼
    ┌─────────────────────┐      ┌─────────────────────┐
    │  支付成功            │      │  支付取消/失败       │
    │  Stripe 重定向       │      │  返回结果页面        │
    └──────────┬──────────┘      └─────────────────────┘
               │
               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    PaymentSuccessPage 支付成功页面                    │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  1. 获取 session_id 参数                                      │   │
│  │  2. 调用 paymentApi.verifyPayment(sessionId)                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Edge Function: verify_stripe_payment                        │   │
│  │  1. 调用 Stripe API 验证支付状态                              │   │
│  │  2. 更新订单状态 (status: completed)                          │   │
│  │  3. 返回支付信息                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  显示支付成功信息                                              │   │
│  │  - 支付金额                                                    │   │
│  │  - 支付方式                                                    │   │
│  │  - 客户邮箱                                                    │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  自动生成 DeepSeek 分析                                        │   │
│  │  (在后台异步进行)                                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│                             ▼                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  引导用户查看分析报告                                          │   │
│  │  - 返回首页按钮                                                │   │
│  │  - 查看分析报告按钮                                            │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
                    ┌────────────────────────────────────────┐
                    │  用户点击"查看分析报告"                 │
                    └──────────┬─────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      ResultPage 结果页面                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  检查分析状态                                                  │   │
│  │  deepseekApi.getAnalysisByTestResult(testId)                 │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                             │                                        │
│              ┌──────────────┴──────────────┐                        │
│              │                              │                        │
│              ▼                              ▼                        │
│  ┌─────────────────────┐      ┌─────────────────────────┐          │
│  │  分析已生成          │      │  分析生成中              │          │
│  │  显示完整分析        │      │  显示等待提示            │          │
│  │  DeepSeekAnalysisCard│      │  (可手动触发生成)        │          │
│  └─────────────────────┘      └─────────────────────────┘          │
└─────────────────────────────────────────────────────────────────────┘
```

## DeepSeek 分析生成流程

```
┌─────────────────────────────────────────────────────────────────────┐
│              Edge Function: generate_deepseek_analysis               │
│                                                                       │
│  1. 验证用户身份 (JWT Token)                                          │
│     ↓                                                                 │
│  2. 验证订单状态 (status: completed)                                  │
│     ↓                                                                 │
│  3. 检查是否已有分析 (避免重复生成)                                    │
│     ↓                                                                 │
│  4. 获取测试结果数据                                                  │
│     - personality_scores (人格特质)                                   │
│     - math_finance_scores (数学金融能力)                              │
│     - risk_preference_scores (风险偏好)                               │
│     - trading_characteristics (交易特征)                              │
│     - investment_style (投资风格)                                     │
│     ↓                                                                 │
│  5. 构建 DeepSeek 提示词                                              │
│     - 角色定位：资深投资心理学家                                       │
│     - 数据输入：完整测评数据                                          │
│     - 分析要求：6大维度，1500-2500字                                  │
│     ↓                                                                 │
│  6. 调用 DeepSeek API                                                 │
│     POST https://api.deepseek.com/v1/chat/completions                │
│     {                                                                 │
│       model: "deepseek-chat",                                         │
│       messages: [system, user],                                       │
│       temperature: 0.7,                                               │
│       max_tokens: 4000                                                │
│     }                                                                 │
│     ↓                                                                 │
│  7. 保存分析结果到数据库                                              │
│     - analysis_content (AI生成的分析)                                 │
│     - prompt_used (使用的提示词)                                      │
│     - test_data_summary (测试数据摘要)                                │
│     ↓                                                                 │
│  8. 返回分析结果                                                      │
│                                                                       │
└─────────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌──────────────┐
│   Frontend   │
│  (React App) │
└──────┬───────┘
       │
       │ 1. createCheckoutSession(items, testResultId)
       ▼
┌──────────────────────────────────────────────────────────┐
│                    Supabase Edge Functions                │
│                                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │  create_stripe_checkout                            │  │
│  │  ├─ 创建订单 → orders 表                           │  │
│  │  └─ 调用 Stripe API → 返回支付 URL                 │  │
│  └────────────────────────────────────────────────────┘  │
│                                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │  verify_stripe_payment                             │  │
│  │  ├─ 验证 Stripe 支付状态                           │  │
│  │  └─ 更新订单状态 → orders 表                       │  │
│  └────────────────────────────────────────────────────┘  │
│                                                            │
│  ┌────────────────────────────────────────────────────┐  │
│  │  generate_deepseek_analysis                        │  │
│  │  ├─ 读取测试结果 → test_results 表                 │  │
│  │  ├─ 调用 DeepSeek API                              │  │
│  │  └─ 保存分析结果 → deepseek_analyses 表           │  │
│  └────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────┘
       │
       │ 2. 返回结果
       ▼
┌──────────────┐
│   Frontend   │
│  显示结果    │
└──────────────┘
```

## 数据库关系图

```
┌─────────────────┐
│     users       │
│  ─────────────  │
│  id (PK)        │
│  email          │
│  created_at     │
└────────┬────────┘
         │
         │ 1:N
         │
    ┌────┴────────────────────────────────┐
    │                                      │
    ▼                                      ▼
┌─────────────────┐              ┌─────────────────┐
│  test_results   │              │     orders      │
│  ─────────────  │              │  ─────────────  │
│  id (PK)        │◄─────────────┤  id (PK)        │
│  user_id (FK)   │      1:N     │  user_id (FK)   │
│  personality... │              │  test_result_id │
│  math_finance...│              │  total_amount   │
│  risk_prefer... │              │  status         │
│  trading_char...│              │  stripe_...     │
│  investment_... │              │  completed_at   │
└────────┬────────┘              └────────┬────────┘
         │                                │
         │ 1:N                            │ 1:1
         │                                │
         ▼                                ▼
┌──────────────────────────────────────────────────┐
│           deepseek_analyses                      │
│  ──────────────────────────────────────────────  │
│  id (PK)                                         │
│  user_id (FK)                                    │
│  test_result_id (FK)                             │
│  order_id (FK)                                   │
│  analysis_content                                │
│  prompt_used                                     │
│  test_data_summary                               │
│  created_at                                      │
└──────────────────────────────────────────────────┘
```

## 状态机图 - 订单状态

```
┌─────────┐
│ pending │  ← 初始状态（创建订单时）
└────┬────┘
     │
     │ 支付成功
     ▼
┌───────────┐
│ completed │  ← 支付完成
└─────┬─────┘
      │
      ├─────────────┐
      │             │
      │ 用户取消    │ 退款
      ▼             ▼
┌───────────┐  ┌──────────┐
│ cancelled │  │ refunded │
└───────────┘  └──────────┘
```

## 时序图 - 完整购买流程

```
用户        ResultPage    PaymentAPI    EdgeFunction    Stripe    DeepSeek    Database
 │              │             │              │            │          │           │
 │ 点击购买     │             │              │            │          │           │
 ├─────────────>│             │              │            │          │           │
 │              │ create      │              │            │          │           │
 │              │ Checkout    │              │            │          │           │
 │              ├────────────>│              │            │          │           │
 │              │             │ invoke       │            │          │           │
 │              │             │ function     │            │          │           │
 │              │             ├─────────────>│            │          │           │
 │              │             │              │ create     │          │           │
 │              │             │              │ order      │          │           │
 │              │             │              ├───────────────────────────────────>│
 │              │             │              │            │          │           │
 │              │             │              │ create     │          │           │
 │              │             │              │ session    │          │           │
 │              │             │              ├───────────>│          │           │
 │              │             │              │<───────────┤          │           │
 │              │             │              │ session    │          │           │
 │              │             │<─────────────┤            │          │           │
 │              │<────────────┤ payment URL  │            │          │           │
 │<─────────────┤             │              │            │          │           │
 │              │             │              │            │          │           │
 │ 打开支付页面 │             │              │            │          │           │
 ├─────────────────────────────────────────────────────────>│          │           │
 │              │             │              │            │          │           │
 │ 完成支付     │             │              │            │          │           │
 ├─────────────────────────────────────────────────────────>│          │           │
 │              │             │              │            │          │           │
 │ 重定向到成功页面                          │            │          │           │
 │<──────────────────────────────────────────────────────────┤          │           │
 │              │             │              │            │          │           │
 │ verify       │             │              │            │          │           │
 │ payment      │             │              │            │          │           │
 ├─────────────>│             │              │            │          │           │
 │              │ verify      │              │            │          │           │
 │              ├────────────>│              │            │          │           │
 │              │             │ invoke       │            │          │           │
 │              │             ├─────────────>│            │          │           │
 │              │             │              │ retrieve   │          │           │
 │              │             │              │ session    │          │           │
 │              │             │              ├───────────>│          │           │
 │              │             │              │<───────────┤          │           │
 │              │             │              │            │          │           │
 │              │             │              │ update     │          │           │
 │              │             │              │ order      │          │           │
 │              │             │              ├───────────────────────────────────>│
 │              │             │              │            │          │           │
 │              │             │<─────────────┤            │          │           │
 │              │<────────────┤ verified     │            │          │           │
 │<─────────────┤             │              │            │          │           │
 │              │             │              │            │          │           │
 │ generate     │             │              │            │          │           │
 │ analysis     │             │              │            │          │           │
 ├─────────────>│             │              │            │          │           │
 │              │ generate    │              │            │          │           │
 │              ├────────────>│              │            │          │           │
 │              │             │ invoke       │            │          │           │
 │              │             ├─────────────>│            │          │           │
 │              │             │              │ get test   │          │           │
 │              │             │              │ result     │          │           │
 │              │             │              ├───────────────────────────────────>│
 │              │             │              │<───────────────────────────────────┤
 │              │             │              │            │          │           │
 │              │             │              │ call API   │          │           │
 │              │             │              ├────────────────────────>│           │
 │              │             │              │<────────────────────────┤           │
 │              │             │              │ analysis   │          │           │
 │              │             │              │            │          │           │
 │              │             │              │ save       │          │           │
 │              │             │              │ analysis   │          │           │
 │              │             │              ├───────────────────────────────────>│
 │              │             │              │            │          │           │
 │              │             │<─────────────┤            │          │           │
 │              │<────────────┤ analysis     │            │          │           │
 │<─────────────┤             │              │            │          │           │
 │              │             │              │            │          │           │
 │ 显示分析报告 │             │              │            │          │           │
 │              │             │              │            │          │           │
```

## 关键决策点

### 1. 何时显示购买按钮？
```
IF 用户未购买 AND 测试已完成
  THEN 显示 PurchaseAnalysisCard
ELSE IF 用户已购买 AND 分析未生成
  THEN 显示 "分析生成中" 提示
ELSE IF 用户已购买 AND 分析已生成
  THEN 显示 DeepSeekAnalysisCard
```

### 2. 何时生成分析？
```
支付成功后自动触发
OR
用户在结果页面手动触发（如果之前失败）
```

### 3. 如何避免重复生成？
```
在 generate_deepseek_analysis 函数中：
1. 检查 deepseek_analyses 表
2. 如果已存在，直接返回缓存的分析
3. 如果不存在，调用 DeepSeek API 生成
```

---

**说明**：
- 所有流程图使用 ASCII 字符绘制，便于在任何文本编辑器中查看
- 箭头表示数据流向或执行顺序
- 虚线表示可选或异步操作
- 实线表示必需或同步操作
