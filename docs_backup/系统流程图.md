# 系统流程图

## 用户使用流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户访问系统                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      邮箱验证码登录                               │
│  1. 输入邮箱                                                      │
│  2. 发送验证码（6位数字，5分钟有效）                              │
│  3. 输入验证码验证                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      开始测评流程                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│  人格测试(50题)   │                    │  交易特征测试     │
│  Big Five 模型   │  →  提交  →        │  交易行为评估     │
└──────────────────┘                    └──────────────────┘
                                                  ↓
                                        ┌──────────────────┐
                                        │ 数学金融测试(10题)│
                                        │  概率、复利等     │
                                        └──────────────────┘
                                                  ↓
                                        ┌──────────────────┐
                                        │  风险偏好测试     │
                                        │  投资场景评估     │
                                        └──────────────────┘
                                                  ↓
┌─────────────────────────────────────────────────────────────────┐
│                      生成基础报告                                 │
│  • 人格特质分析                                                   │
│  • 投资风格匹配（欧几里得距离算法）                                │
│  • 数学金融能力评估                                               │
│  • 风险偏好分析                                                   │
│  • 投资建议                                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│              是否购买 DeepSeek AI 深度分析？                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│  使用礼品码       │                    │   付费购买        │
│  免费获取分析     │                    │   递减价格策略    │
└──────────────────┘                    └──────────────────┘
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│ 1. 输入礼品码     │                    │ 首次：¥3.99      │
│ 2. 验证有效性     │                    │ 第二次：¥2.99    │
│ 3. 扣除使用次数   │                    │ 第三次+：¥1.99   │
└──────────────────┘                    └──────────────────┘
        ↓                                           ↓
        └─────────────────────┬─────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                  生成 DeepSeek AI 深度分析                        │
│  • 投资心理深度剖析                                               │
│  • 个性化交易策略                                                 │
│  • 风险管理建议                                                   │
│  • 心理陷阱预警                                                   │
│  • 成长路径规划                                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      查看完整报告                                 │
│  • 在线查看                                                       │
│  • 下载 PDF（可选）                                               │
└─────────────────────────────────────────────────────────────────┘
```

---

## 礼品码系统流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      管理员生成礼品码                             │
│  • 设置最大兑换次数（1-999）                                      │
│  • 设置有效期（可选，默认永久）                                    │
│  • 生成8位随机码                                                  │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      礼品码存储到数据库                           │
│  gift_codes 表：                                                 │
│  • code: 礼品码字符串                                             │
│  • max_redemptions: 最大兑换次数                                  │
│  • current_redemptions: 当前已兑换次数                            │
│  • is_active: 是否激活                                           │
│  • expires_at: 过期时间                                          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      用户兑换礼品码                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 验证礼品码    │    │ 检查是否过期  │    │ 检查使用次数  │
│ 是否存在      │    │              │    │              │
└──────────────┘    └──────────────┘    └──────────────┘
        ↓                     ↓                     ↓
        └─────────────────────┬─────────────────────┘
                              ↓
                    ┌──────────────────┐
                    │   验证是否激活    │
                    └──────────────────┘
                              ↓
                    ┌──────────────────┐
                    │  检查用户是否     │
                    │  已兑换过此码     │
                    └──────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                                           ↓
┌──────────────────┐                    ┌──────────────────┐
│   验证失败        │                    │   验证成功        │
│   返回错误信息    │                    │   创建兑换记录    │
└──────────────────┘                    └──────────────────┘
                                                  ↓
                                        ┌──────────────────┐
                                        │ gift_code_       │
                                        │ redemptions 表： │
                                        │ • user_id        │
                                        │ • gift_code_id   │
                                        │ • remaining_uses │
                                        └──────────────────┘
                                                  ↓
                                        ┌──────────────────┐
                                        │ 更新礼品码        │
                                        │ current_         │
                                        │ redemptions + 1  │
                                        └──────────────────┘
                                                  ↓
                                        ┌──────────────────┐
                                        │ 用户获得免费次数  │
                                        └──────────────────┘
```

---

## 付费购买流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      用户点击"立即购买"                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      查询用户定价信息                             │
│  user_pricing_info 表：                                          │
│  • completed_analyses: 已完成分析次数                             │
│  • next_price: 下次购买价格                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────────────┴─────────────────────┐
        ↓                     ↓                     ↓
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ 首次购买      │    │ 第二次购买    │    │ 第三次+购买   │
│ ¥3.99        │    │ ¥2.99        │    │ ¥1.99        │
└──────────────┘    └──────────────┘    └──────────────┘
        ↓                     ↓                     ↓
        └─────────────────────┬─────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      创建订单记录                                 │
│  orders 表：                                                     │
│  • user_id: 用户ID                                               │
│  • test_result_id: 测试结果ID                                    │
│  • amount: 订单金额（分）                                         │
│  • status: 'pending'                                            │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      跳转到支付页面                               │
│  （演示环境：需要手动标记订单完成）                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      支付成功回调                                 │
│  • 更新订单状态：status = 'completed'                             │
│  • 记录完成时间：completed_at = now()                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      触发分析生成                                 │
│  • 调用 DeepSeek API                                             │
│  • 生成深度分析报告                                               │
│  • 保存到 deepseek_analyses 表                                   │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      更新用户定价信息                             │
│  • completed_analyses + 1                                       │
│  • 计算下次价格（递减）                                           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      显示分析报告                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 管理后台流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      管理员登录系统                               │
│  • 使用管理员邮箱登录                                             │
│  • 系统检查 profiles.role = 'admin'                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                      访问管理后台                                 │
└─────────────────────────────────────────────────────────────────┘
                              ↓
        ┌─────────────┬───────┴───────┬─────────────┐
        ↓             ↓               ↓             ↓
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│  概览     │  │ 用户管理  │  │ 订单管理  │  │礼品码管理│
└──────────┘  └──────────┘  └──────────┘  └──────────┘
        ↓             ↓               ↓             ↓
┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
│• 总用户数 │  │• 用户列表 │  │• 订单列表 │  │• 生成码  │
│• 总测试数 │  │• 测试历史 │  │• 状态筛选 │  │• 码列表  │
│• 总订单数 │  │• 订单历史 │  │• 订单详情 │  │• 激活/停用│
│• 总收入   │  │• 定价信息 │  │          │  │• 使用统计 │
│• 码统计   │  │          │  │          │  │          │
└──────────┘  └──────────┘  └──────────┘  └──────────┘
```

---

## 数据库表关系图

```
┌──────────────┐
│   profiles   │  用户资料表
│──────────────│
│ id (PK)      │◄─────────┐
│ email        │          │
│ role         │          │
│ created_at   │          │
└──────────────┘          │
                          │
        ┌─────────────────┼─────────────────┐
        │                 │                 │
        ↓                 ↓                 ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│test_results  │  │   orders     │  │gift_code_    │
│              │  │              │  │redemptions   │
│──────────────│  │──────────────│  │──────────────│
│ id (PK)      │  │ id (PK)      │  │ id (PK)      │
│ user_id (FK) │  │ user_id (FK) │  │ user_id (FK) │
│ personality_ │  │ test_result_ │  │ gift_code_id │
│   scores     │  │   id (FK)    │  │ remaining_   │
│ investment_  │  │ amount       │  │   uses       │
│   style      │  │ status       │  │ redeemed_at  │
└──────────────┘  └──────────────┘  └──────────────┘
        │                 │                 │
        │                 │                 │
        ↓                 ↓                 ↓
┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│deepseek_     │  │user_pricing_ │  │ gift_codes   │
│analyses      │  │info          │  │              │
│──────────────│  │──────────────│  │──────────────│
│ id (PK)      │  │ id (PK)      │  │ id (PK)      │
│ test_result_ │  │ user_id (FK) │  │ code (UNIQUE)│
│   id (FK)    │  │ completed_   │  │ max_         │
│ analysis_    │  │   analyses   │  │   redemptions│
│   content    │  │ next_price   │  │ current_     │
│ created_at   │  │              │  │   redemptions│
└──────────────┘  └──────────────┘  │ is_active    │
                                    │ expires_at   │
                                    └──────────────┘
```

---

## 价格递减机制

```
用户首次购买
    ↓
┌─────────────────────┐
│ completed_analyses  │
│        = 0          │
│                     │
│ next_price = 399    │
│   (¥3.99)          │
└─────────────────────┘
    ↓ 购买完成
┌─────────────────────┐
│ completed_analyses  │
│        = 1          │
│                     │
│ next_price = 299    │
│   (¥2.99)          │
└─────────────────────┘
    ↓ 再次购买
┌─────────────────────┐
│ completed_analyses  │
│        = 2          │
│                     │
│ next_price = 199    │
│   (¥1.99)          │
└─────────────────────┘
    ↓ 继续购买
┌─────────────────────┐
│ completed_analyses  │
│        >= 3         │
│                     │
│ next_price = 199    │
│   (¥1.99) 保持     │
└─────────────────────┘
```

---

## 系统安全机制

```
┌─────────────────────────────────────────────────────────────────┐
│                      验证码安全机制                               │
│  • 6位随机数字                                                    │
│  • 5分钟有效期                                                    │
│  • 使用后自动标记为已使用                                          │
│  • 过期自动失效                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      礼品码安全机制                               │
│  • 唯一性验证（数据库 UNIQUE 约束）                               │
│  • 使用次数限制                                                   │
│  • 有效期检查                                                     │
│  • 激活状态控制                                                   │
│  • 用户重复兑换检查                                               │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      订单安全机制                                 │
│  • 订单状态管理（pending/completed/cancelled）                   │
│  • 金额验证                                                       │
│  • 用户关联验证                                                   │
│  • 重复支付检查                                                   │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      管理员权限控制                               │
│  • 角色验证（role = 'admin'）                                    │
│  • 路由保护                                                       │
│  • API 权限检查                                                   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 测试流程图

```
开始测试
    ↓
┌─────────────────────┐
│ 1. 设置管理员        │
│    • 登录系统        │
│    • 执行SQL设置角色 │
│    • 验证权限        │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 2. 生成礼品码        │
│    • 进入管理后台    │
│    • 设置参数        │
│    • 生成并复制      │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 3. 测试礼品码        │
│    • 切换用户        │
│    • 完成测试        │
│    • 兑换礼品码      │
│    • 使用免费次数    │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 4. 测试付费          │
│    • 创建订单        │
│    • 模拟支付        │
│    • 验证分析生成    │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 5. 测试价格递减      │
│    • 重复购买        │
│    • 验证价格变化    │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 6. 验证管理后台      │
│    • 查看统计        │
│    • 管理用户        │
│    • 管理订单        │
│    • 管理礼品码      │
└─────────────────────┘
    ↓
测试完成 ✅
```

---

## 故障排查流程

```
遇到问题
    ↓
┌─────────────────────┐
│ 1. 查看错误信息      │
│    • 浏览器控制台    │
│    • 页面提示        │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 2. 检查数据库        │
│    • 表是否存在      │
│    • 数据是否正确    │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 3. 验证配置          │
│    • 环境变量        │
│    • 用户角色        │
└─────────────────────┘
    ↓
┌─────────────────────┐
│ 4. 查看文档          │
│    • 常见问题        │
│    • 解决方案        │
└─────────────────────┘
    ↓
问题解决 ✅
```
