# âœ… ç®¡ç†å‘˜æƒé™å·²è®¾ç½®

## ğŸ‰ å¥½æ¶ˆæ¯

æ‚¨çš„è´¦å· **1062250152@qq.com** å·²æˆåŠŸè®¾ç½®ä¸ºç®¡ç†å‘˜ï¼

---

## ğŸ“‹ å·²å®Œæˆçš„æ“ä½œ

### 1. æ•°æ®åº“é…ç½® âœ…
- åœ¨ `profiles` è¡¨ä¸­åˆ›å»ºäº†æ‚¨çš„ç®¡ç†å‘˜è®°å½•
- è§’è‰²è®¾ç½®ä¸º: `admin`
- ç”¨æˆ· ID: `ab591cd0-bcff-40f4-bc2f-20ce58cb07eb`

### 2. Edge Functions æ›´æ–° âœ…
- **verify-code-and-login** (v4): ç™»å½•æ—¶è¿”å›ç”¨æˆ·è§’è‰²
- **verify-token** (v4): Token éªŒè¯æ—¶è¿”å›ç”¨æˆ·è§’è‰²

### 3. å‰ç«¯ä»£ç æ›´æ–° âœ…
- AuthContext: User æ¥å£æ·»åŠ  `role` å­—æ®µ
- auth.ts: User æ¥å£æ·»åŠ  `role` å­—æ®µ
- adminApi.ts: isAdmin() å‡½æ•°ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å¯¹è±¡ä¸­çš„ role

---

## ğŸš€ å¦‚ä½•ä½¿ç”¨ç®¡ç†å‘˜åŠŸèƒ½

### æ–¹æ³• 1: é‡æ–°ç™»å½•ï¼ˆæ¨èï¼‰

1. **é€€å‡ºç™»å½•**
   - ç‚¹å‡»å³ä¸Šè§’çš„"é€€å‡ºç™»å½•"æŒ‰é’®

2. **é‡æ–°ç™»å½•**
   - è¾“å…¥é‚®ç®±: `1062250152@qq.com`
   - ç‚¹å‡»"å‘é€éªŒè¯ç "
   - è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç 
   - ç‚¹å‡»"éªŒè¯ç™»å½•"

3. **è®¿é—®ç®¡ç†å‘˜åå°**
   - ç™»å½•æˆåŠŸåï¼Œæ‚¨ä¼šåœ¨é¦–é¡µå³ä¸Šè§’çœ‹åˆ°ä¸€ä¸ªè“è‰²çš„**"ç®¡ç†å‘˜åå°"**æŒ‰é’®ï¼ˆå¸¦ç›¾ç‰Œå›¾æ ‡ ğŸ›¡ï¸ï¼‰
   - ç‚¹å‡»è¯¥æŒ‰é’®å³å¯è¿›å…¥ç®¡ç†å‘˜åå°
   - æˆ–è€…ç›´æ¥è®¿é—® `/admin` è·¯å¾„

### æ–¹æ³• 2: åˆ·æ–°é¡µé¢ï¼ˆå¦‚æœå·²ç»ç™»å½•ï¼‰

1. **ç¡¬åˆ·æ–°æµè§ˆå™¨**
   - Windows/Linux: æŒ‰ `Ctrl + Shift + R`
   - Mac: æŒ‰ `Cmd + Shift + R`

2. **æŸ¥çœ‹é¦–é¡µå³ä¸Šè§’**
   - åˆ·æ–°åï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ°è“è‰²çš„"ç®¡ç†å‘˜åå°"æŒ‰é’®
   - å¦‚æœè¿˜æ˜¯çœ‹ä¸åˆ°ï¼Œè¯·å°è¯•æ¸…é™¤ç¼“å­˜åé‡æ–°ç™»å½•

---

## ğŸ¨ ç®¡ç†å‘˜æŒ‰é’®ä½ç½®ç¤ºæ„

ç™»å½•åï¼Œæ‚¨ä¼šåœ¨é¦–é¡µçœ‹åˆ°ä»¥ä¸‹å¸ƒå±€ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äººæ ¼ç‰¹è´¨æŠ•èµ„ç­–ç•¥è¯„ä¼°ç³»ç»Ÿ                                          â”‚
â”‚  åŸºäºç§‘å­¦çš„äººæ ¼æµ‹è¯„å’Œé‡‘èçŸ¥è¯†è¯„ä¼°ï¼Œä¸ºæ‚¨æ¨èæœ€é€‚åˆçš„æŠ•èµ„ç­–ç•¥          â”‚
â”‚                                                                   â”‚
â”‚  1062250152@qq.com  [ğŸ›¡ï¸ ç®¡ç†å‘˜åå°]  [ğŸ® æ¸¸æˆä¸­å¿ƒ]  [ğŸ“œ æµ‹è¯•å†å²]  [ğŸšª é€€å‡ºç™»å½•]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹å¾**ï¼š
- ğŸ›¡ï¸ **ç®¡ç†å‘˜åå°**æŒ‰é’®ï¼šè“è‰²èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ï¼Œå¸¦ç›¾ç‰Œå›¾æ ‡
- åªæœ‰ç®¡ç†å‘˜ç”¨æˆ·æ‰èƒ½çœ‹åˆ°æ­¤æŒ‰é’®
- æ™®é€šç”¨æˆ·ä¸ä¼šçœ‹åˆ°æ­¤æŒ‰é’®

---

## ğŸ” éªŒè¯ç®¡ç†å‘˜æƒé™

### åœ¨æµè§ˆå™¨æ§åˆ¶å°éªŒè¯

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼Œè¿è¡Œä»¥ä¸‹ä»£ç ï¼š

```javascript
// æ£€æŸ¥å½“å‰ç”¨æˆ·ä¿¡æ¯
const token = localStorage.getItem('auth_token');
console.log('Token:', token);

// è·å–ç”¨æˆ·ä¿¡æ¯
fetch('https://ahgnspudsmrvsqcinxcj.supabase.co/functions/v1/verify-token', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZ25zcHVkc21ydnNxY2lueGNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjY3OTksImV4cCI6MjA3ODM0Mjc5OX0.KZkaD_GdgMXe_e7Eo0i6yf23-YyADnne3Biq9iizuW0'
  }
})
.then(res => res.json())
.then(data => {
  console.log('ç”¨æˆ·ä¿¡æ¯:', data);
  console.log('è§’è‰²:', data.user?.role);
  if (data.user?.role === 'admin') {
    console.log('âœ… æ‚¨æ˜¯ç®¡ç†å‘˜ï¼');
  } else {
    console.log('âŒ æ‚¨ä¸æ˜¯ç®¡ç†å‘˜');
  }
});
```

**é¢„æœŸè¾“å‡º**:
```
ç”¨æˆ·ä¿¡æ¯: { valid: true, user: { id: "...", email: "1062250152@qq.com", role: "admin", ... } }
è§’è‰²: admin
âœ… æ‚¨æ˜¯ç®¡ç†å‘˜ï¼
```

---

## ğŸ“Š ç®¡ç†å‘˜åŠŸèƒ½åˆ—è¡¨

ä½œä¸ºç®¡ç†å‘˜ï¼Œæ‚¨å¯ä»¥è®¿é—®ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. ç®¡ç†å‘˜åå° (`/admin`)
- æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡æ•°æ®
- ç”¨æˆ·ç®¡ç†
- æµ‹è¯•æäº¤è®°å½•
- ç®¡ç†å‘˜æ“ä½œæ—¥å¿—
- ç¤¼å“ç ç®¡ç†

### 2. ç³»ç»Ÿè®¾ç½® (`/admin/settings`)
- æ”¯ä»˜å¼€å…³æ§åˆ¶
- DeepSeek AI å¼€å…³æ§åˆ¶
- ç³»ç»Ÿé…ç½®ç®¡ç†

### 3. æ•°æ®ç®¡ç†
- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„æµ‹è¯•ç»“æœ
- æŸ¥çœ‹æ”¯ä»˜è®°å½•
- IP ç»Ÿè®¡åˆ†æ
- åœ°ç†ä½ç½®ç»Ÿè®¡

### 4. ç”¨æˆ·ç®¡ç†
- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·èµ„æ–™
- ä¿®æ”¹ç”¨æˆ·è§’è‰²
- æŸ¥çœ‹ç”¨æˆ·å®šä»·ä¿¡æ¯

---

## ğŸ” å®‰å…¨æç¤º

### ç®¡ç†å‘˜æƒé™è¯´æ˜

- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰ç”¨æˆ·æ•°æ®
- ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç³»ç»Ÿé…ç½®
- ç®¡ç†å‘˜æ“ä½œä¼šè¢«è®°å½•åœ¨æ—¥å¿—ä¸­
- è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ç™»å½•å‡­è¯

### è‡ªåŠ¨ç®¡ç†å‘˜åˆ†é…

ç³»ç»Ÿå·²é…ç½®è‡ªåŠ¨ç®¡ç†å‘˜åˆ†é…æœºåˆ¶ï¼š
- é‚®ç®± `1062250152@qq.com` åœ¨æ³¨å†Œæ—¶è‡ªåŠ¨è·å¾—ç®¡ç†å‘˜æƒé™
- å…¶ä»–ç”¨æˆ·é»˜è®¤ä¸ºæ™®é€šç”¨æˆ·è§’è‰²
- ç®¡ç†å‘˜å¯ä»¥æ‰‹åŠ¨æå‡å…¶ä»–ç”¨æˆ·ä¸ºç®¡ç†å‘˜

---

## ğŸ› ï¸ æŠ€æœ¯ç»†èŠ‚

### æ•°æ®åº“è¡¨ç»“æ„

**profiles è¡¨**:
```sql
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id),
  email TEXT UNIQUE,
  role user_role DEFAULT 'user'::user_role NOT NULL,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**user_role æšä¸¾**:
```sql
CREATE TYPE user_role AS ENUM ('user', 'admin');
```

### Edge Functions

**verify-code-and-login** (v4):
- ç™»å½•æ—¶ä» `profiles` è¡¨æŸ¥è¯¢ç”¨æˆ·è§’è‰²
- è¿”å›æ ¼å¼: `{ success: true, token: "...", user: { id, email, role, created_at } }`

**verify-token** (v4):
- Token éªŒè¯æ—¶ä» `profiles` è¡¨æŸ¥è¯¢ç”¨æˆ·è§’è‰²
- è¿”å›æ ¼å¼: `{ valid: true, user: { id, email, role, created_at } }`

### å‰ç«¯æƒé™æ£€æŸ¥

**adminApi.isAdmin()**:
```typescript
async isAdmin(): Promise<boolean> {
  const { data: { user } } = await getCurrentUser();
  if (!user) return false;
  
  // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·å¯¹è±¡ä¸­çš„ role
  if (user.role === 'admin') return true;
  
  // å¤‡ç”¨ï¼šä» profiles è¡¨æŸ¥è¯¢
  const { data } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', user.id)
    .maybeSingle();
  
  return data?.role === 'admin';
}
```

---

## ğŸ“ å¸¸è§é—®é¢˜

### Q1: é‡æ–°ç™»å½•åè¿˜æ˜¯æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Ÿ

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®è®¤æ‚¨ä½¿ç”¨çš„é‚®ç®±æ˜¯ `1062250152@qq.com`ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
2. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œ localStorage
3. åœ¨æ§åˆ¶å°è¿è¡ŒéªŒè¯è„šæœ¬æ£€æŸ¥è§’è‰²
4. æŸ¥çœ‹ Network æ ‡ç­¾ï¼Œç¡®è®¤ verify-token è¿”å›çš„ role æ˜¯ "admin"

### Q2: å¦‚ä½•æ·»åŠ å…¶ä»–ç®¡ç†å‘˜ï¼Ÿ

**æ–¹æ³• 1: é€šè¿‡ SQL**
```sql
UPDATE profiles 
SET role = 'admin'::user_role 
WHERE email = 'å…¶ä»–é‚®ç®±@example.com';
```

**æ–¹æ³• 2: é€šè¿‡ç®¡ç†å‘˜åå°**
- ç™»å½•ç®¡ç†å‘˜åå°
- è¿›å…¥ç”¨æˆ·ç®¡ç†é¡µé¢
- æ‰¾åˆ°ç›®æ ‡ç”¨æˆ·
- ä¿®æ”¹è§’è‰²ä¸º "admin"

### Q3: å¦‚ä½•å–æ¶ˆç®¡ç†å‘˜æƒé™ï¼Ÿ

```sql
UPDATE profiles 
SET role = 'user'::user_role 
WHERE email = 'é‚®ç®±@example.com';
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **é‡æ–°ç™»å½•**
   - é€€å‡ºå½“å‰ç™»å½•
   - ä½¿ç”¨ `1062250152@qq.com` é‡æ–°ç™»å½•

2. **è®¿é—®ç®¡ç†å‘˜åå°**
   - è®¿é—® `/admin` è·¯å¾„
   - æŸ¥çœ‹ç³»ç»Ÿç»Ÿè®¡æ•°æ®

3. **æ¢ç´¢ç®¡ç†åŠŸèƒ½**
   - ç”¨æˆ·ç®¡ç†
   - ç³»ç»Ÿè®¾ç½®
   - æ•°æ®åˆ†æ

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰

å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

---

**æœ€åæ›´æ–°**: 2025-01-14  
**æ•°æ®åº“çŠ¶æ€**: âœ… ç®¡ç†å‘˜è®°å½•å·²åˆ›å»º  
**Edge Functions**: âœ… v4 å·²éƒ¨ç½²  
**å‰ç«¯ä»£ç **: âœ… å·²æ›´æ–°
