# 系统测试指南

## 测试前准备

### 1. 环境检查

确保以下环境变量已配置：
- `VITE_SUPABASE_URL` - Supabase 项目 URL
- `VITE_SUPABASE_ANON_KEY` - Supabase Anon Key
- `DEEPSEEK_API_KEY` - DeepSeek API Key（在 Supabase Dashboard 配置）

### 2. 数据库迁移

在 Supabase Dashboard > SQL Editor 中按顺序运行：
1. `supabase/migrations/32_migrate_to_supabase_auth.sql`
2. `supabase/migrations/33_admin_email_restriction.sql`
3. `supabase/migrations/34_update_rls_policies.sql`

### 3. Supabase Auth 配置

1. **启用 Email Provider**:
   - Authentication > Providers > Email
   - 确保已启用
   - 配置 SMTP（可选，用于邮件验证）

2. **配置 Google OAuth**（可选）:
   - Authentication > Providers > Google
   - 启用 Google provider
   - 配置 OAuth Client ID 和 Secret
   - Redirect URL: `http://localhost:5173/` (开发) 或 `https://your-domain.com/` (生产)

3. **配置 Apple OAuth**（可选）:
   - Authentication > Providers > Apple
   - 启用 Apple provider
   - 配置 Apple OAuth 凭据
   - Redirect URL: `http://localhost:5173/` (开发) 或 `https://your-domain.com/` (生产)

### 4. Storage 配置

1. 创建 Storage bucket `public`（如果不存在）
2. 设置为公开访问
3. 上传 `wechat-reward.jpg` 到 bucket

### 5. 设置管理员

确保 `1062250152@qq.com` 在 Supabase Auth 中注册，并设置为管理员：

```sql
-- 在 Supabase Dashboard > SQL Editor 中运行
UPDATE public.profiles 
SET role = 'admin' 
WHERE email = '1062250152@qq.com';
```

## 测试清单

### 1. 认证系统测试

#### 1.1 邮箱密码注册
- [ ] 访问登录页面
- [ ] 点击"没有账号？去注册"
- [ ] 输入邮箱和密码（至少6位）
- [ ] 点击"注册"
- [ ] 验证：注册成功，自动登录，跳转到首页
- [ ] 验证：在 Supabase Dashboard > Authentication > Users 中看到新用户
- [ ] 验证：在 `profiles` 表中看到新用户的 profile（role='user'）

#### 1.2 邮箱密码登录
- [ ] 使用已注册的邮箱和密码登录
- [ ] 验证：登录成功，跳转到首页
- [ ] 验证：用户信息正确显示

#### 1.3 Google OAuth 登录（如果已配置）
- [ ] 点击"Google"登录按钮
- [ ] 验证：跳转到 Google 登录页面
- [ ] 完成 Google 登录
- [ ] 验证：返回应用，自动登录
- [ ] 验证：用户信息正确显示

#### 1.4 Apple OAuth 登录（如果已配置）
- [ ] 点击"Apple"登录按钮
- [ ] 验证：跳转到 Apple 登录页面
- [ ] 完成 Apple 登录
- [ ] 验证：返回应用，自动登录
- [ ] 验证：用户信息正确显示

#### 1.5 退出登录
- [ ] 点击"退出登录"按钮
- [ ] 验证：退出成功，跳转到登录页面
- [ ] 验证：用户信息已清除

#### 1.6 会话持久化
- [ ] 登录后刷新页面
- [ ] 验证：用户仍然登录状态
- [ ] 验证：用户信息正确显示

### 2. 测试流程测试

#### 2.1 开始测试
- [ ] 登录后点击"开始测试"
- [ ] 选择测试模式（快速/完整）
- [ ] 验证：创建测试记录成功
- [ ] 验证：跳转到第一个测试页面

#### 2.2 完成测试
- [ ] 完成人格特质测试（50题）
- [ ] 完成交易特征测试
- [ ] 完成数学金融能力测试（10题）
- [ ] 完成风险偏好测试
- [ ] 验证：自动跳转到结果页面
- [ ] 验证：基础报告正确生成

### 3. 礼品码系统测试

#### 3.1 管理员生成礼品码
- [ ] 使用 `1062250152@qq.com` 登录
- [ ] 进入管理员后台
- [ ] 导航到礼品码管理
- [ ] 生成新礼品码
- [ ] 验证：礼品码成功生成
- [ ] 验证：礼品码显示在列表中

#### 3.2 用户兑换礼品码
- [ ] 使用普通用户登录
- [ ] 完成测试，进入结果页面
- [ ] 点击"有礼品码？点击兑换"
- [ ] 输入礼品码
- [ ] 点击"兑换"
- [ ] 验证：兑换成功，显示"您获得15次免费分析"
- [ ] 验证：免费分析次数显示为15

#### 3.3 使用免费分析
- [ ] 在结果页面看到"您有免费分析次数"卡片
- [ ] 点击"免费获取深度分析"
- [ ] 验证：调用 DeepSeek API 成功
- [ ] 验证：分析结果正确显示
- [ ] 验证：免费分析次数减少1（变为14）

#### 3.4 免费次数持久化
- [ ] 使用免费分析后退出登录
- [ ] 重新登录
- [ ] 验证：免费分析次数仍然保留（14次）
- [ ] 验证：可以继续使用免费分析

#### 3.5 多次兑换礼品码
- [ ] 兑换另一个礼品码
- [ ] 验证：免费分析次数累加（14 + 15 = 29）

### 4. DeepSeek API 测试

#### 4.1 免费分析生成
- [ ] 使用免费分析次数生成分析
- [ ] 验证：Edge Function 正确验证 Supabase Auth token
- [ ] 验证：DeepSeek API 调用成功
- [ ] 验证：分析内容正确保存到数据库
- [ ] 验证：分析结果正确显示

#### 4.2 分析结果查看
- [ ] 查看已生成的分析
- [ ] 验证：分析内容正确显示
- [ ] 验证：可以下载 JSON 格式
- [ ] 验证：可以保存到本地

### 5. PDF 报告测试

#### 5.1 PDF 下载
- [ ] 在结果页面点击"下载PDF"
- [ ] 验证：浏览器打印对话框打开
- [ ] 验证：选择"另存为PDF"可以保存
- [ ] 验证：PDF 内容正确

#### 5.2 报告内容
- [ ] 验证：报告包含所有测试结果
- [ ] 验证：报告包含投资风格匹配结果
- [ ] 验证：报告包含各项分析内容

### 6. 管理员后台测试

#### 6.1 管理员访问控制
- [ ] 使用 `1062250152@qq.com` 登录
- [ ] 验证：可以看到"管理员后台"按钮
- [ ] 验证：可以访问管理员后台
- [ ] 使用普通用户登录
- [ ] 验证：看不到"管理员后台"按钮
- [ ] 验证：直接访问 `/admin` 被重定向到首页

#### 6.2 管理员功能
- [ ] 查看统计数据
- [ ] 查看用户列表
- [ ] 查看订单列表
- [ ] 管理礼品码
- [ ] 验证：所有功能正常工作

### 7. 微信赞赏码测试

#### 7.1 图片显示
- [ ] 在结果页面查看微信赞赏码
- [ ] 验证：图片正确显示（从 Supabase Storage）
- [ ] 验证：图片加载失败时有 fallback

### 8. RLS 策略测试

#### 8.1 数据隔离
- [ ] 使用用户A登录
- [ ] 完成测试，查看测试结果
- [ ] 使用用户B登录
- [ ] 验证：用户B看不到用户A的测试结果
- [ ] 验证：用户B看不到用户A的分析结果
- [ ] 验证：用户B看不到用户A的订单

#### 8.2 管理员权限
- [ ] 使用管理员登录
- [ ] 验证：可以看到所有用户的测试结果
- [ ] 验证：可以看到所有用户的分析结果
- [ ] 验证：可以看到所有订单

## 常见问题排查

### 问题1：登录失败
- **检查**：Supabase Auth 是否已启用 Email provider
- **检查**：环境变量是否正确配置
- **检查**：浏览器控制台是否有错误信息

### 问题2：DeepSeek API 调用失败
- **检查**：`DEEPSEEK_API_KEY` 是否在 Supabase Dashboard 中配置
- **检查**：Edge Function 是否正确部署
- **检查**：用户是否已登录（Supabase Auth session 是否存在）

### 问题3：礼品码兑换失败
- **检查**：礼品码是否存在且激活
- **检查**：礼品码是否过期
- **检查**：用户是否已兑换过此礼品码
- **检查**：数据库迁移是否已运行

### 问题4：管理员后台无法访问
- **检查**：用户邮箱是否为 `1062250152@qq.com`
- **检查**：`profiles` 表中用户角色是否为 `admin`
- **检查**：数据库函数 `is_admin_by_email` 是否正确

### 问题5：微信赞赏码不显示
- **检查**：Storage bucket `public` 是否存在
- **检查**：图片是否已上传到 bucket
- **检查**：bucket 是否设置为公开访问
- **检查**：图片文件名是否为 `wechat-reward.jpg`

## 测试脚本

### 快速测试脚本

```bash
# 1. 启动开发服务器
npm run dev

# 2. 在浏览器中打开 http://localhost:5173

# 3. 按顺序执行测试清单
```

### 自动化测试（可选）

可以创建 E2E 测试脚本，使用 Playwright 或 Cypress 进行自动化测试。

## 测试报告模板

测试完成后，请填写以下信息：

- **测试日期**：___________
- **测试人员**：___________
- **测试环境**：开发 / 生产
- **通过的功能**：___________
- **失败的功能**：___________
- **发现的问题**：___________
- **建议**：___________

