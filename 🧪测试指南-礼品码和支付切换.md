# 🧪 测试指南 - 礼品码生成和支付系统切换

## 🎯 测试目标

验证以下两个功能已修复：
1. ✅ 礼品码生成
2. ✅ 支付系统切换

## 📋 前置条件

- ✅ 已登录管理员账号（1062250152@qq.com）
- ✅ 能看到"管理员后台"按钮
- ✅ 能进入管理员后台页面

## 🧪 测试步骤

### 测试 1: 礼品码生成

#### 步骤

1. **进入管理员后台**
   - 点击首页右上角的"管理员后台"按钮
   - 等待页面加载完成

2. **打开礼品码管理**
   - 点击"礼品码管理"标签
   - 应该能看到礼品码生成表单

3. **填写礼品码信息**
   - 数量：`1`
   - 最大兑换次数：`1`
   - 免费分析次数：`15`
   - 有效期（可选）：留空或选择未来日期

4. **生成礼品码**
   - 点击"生成礼品码"按钮
   - 等待响应

#### 预期结果 ✅

- ✅ 显示成功提示："礼品码生成成功"
- ✅ 礼品码列表中出现新生成的礼品码
- ✅ 礼品码格式正确（例如：`GIFT-XXXX-XXXX`）
- ✅ 状态显示为"激活"
- ✅ 当前兑换次数为 0

#### 如果失败 ❌

**之前的错误（已修复）：**
```
Foreign key constraint violation
Key (created_by)=(18bd1fdc-a571-4ea1-bf58-ae5f844eb480) 
is not present in table "profiles"
```

**现在应该不会出现此错误！**

如果仍然失败，请检查：
1. 控制台是否有其他错误信息
2. 网络请求是否成功（F12 → Network）
3. 数据库迁移是否已应用

---

### 测试 2: 支付系统切换

#### 步骤

1. **进入管理员后台**
   - 如果还在礼品码管理页面，继续下一步
   - 否则，点击首页的"管理员后台"按钮

2. **打开系统设置**
   - 点击"系统设置"标签
   - 应该能看到"支付系统状态"开关

3. **查看当前状态**
   - 记录当前开关状态（开启/关闭）
   - 记录当前显示的文字

4. **切换支付系统**
   - 点击开关，切换状态
   - 等待响应

5. **验证切换结果**
   - 检查开关状态是否改变
   - 检查显示文字是否更新

6. **再次切换**
   - 再次点击开关，切换回原状态
   - 验证能否正常切换

#### 预期结果 ✅

**第一次切换：**
- ✅ 显示成功提示："支付系统已启用" 或 "支付系统已禁用"
- ✅ 开关状态立即改变
- ✅ 显示文字更新为对应状态
- ✅ 没有错误提示

**第二次切换：**
- ✅ 同样能成功切换
- ✅ 状态正确更新
- ✅ 没有错误提示

#### 如果失败 ❌

**之前的错误（已修复）：**
```
Unauthorized: Only admins can toggle payment system
Code: P0001
```

**现在应该不会出现此错误！**

如果仍然失败，请检查：
1. 控制台是否显示权限错误
2. 用户 ID 是否正确
3. `is_admin_by_id` 函数是否正确识别管理员

---

## 🔍 调试信息

### 打开浏览器控制台

按 **F12** 打开开发者工具，查看：

1. **Console 标签**
   - 查看是否有 JavaScript 错误
   - 查看是否有 API 请求错误
   - 查看管理员权限验证日志

2. **Network 标签**
   - 查看 API 请求是否成功
   - 查看请求参数是否正确
   - 查看响应内容

### 关键日志

**礼品码生成：**
```javascript
// 应该看到类似的日志
POST /rest/v1/rpc/generate_gift_codes
Status: 200 OK
Response: [{"code": "GIFT-XXXX-XXXX", ...}]
```

**支付系统切换：**
```javascript
// 应该看到类似的日志
POST /rest/v1/rpc/toggle_payment_system
Status: 200 OK
Response: {"success": true, "enabled": true, ...}
```

---

## 📊 测试结果记录

### 礼品码生成测试

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 能否打开礼品码管理页面 | ⬜ 通过 / ⬜ 失败 | |
| 能否填写表单 | ⬜ 通过 / ⬜ 失败 | |
| 能否点击生成按钮 | ⬜ 通过 / ⬜ 失败 | |
| 是否显示成功提示 | ⬜ 通过 / ⬜ 失败 | |
| 礼品码是否出现在列表中 | ⬜ 通过 / ⬜ 失败 | |
| 礼品码格式是否正确 | ⬜ 通过 / ⬜ 失败 | |

### 支付系统切换测试

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 能否打开系统设置页面 | ⬜ 通过 / ⬜ 失败 | |
| 能否看到支付系统开关 | ⬜ 通过 / ⬜ 失败 | |
| 第一次切换是否成功 | ⬜ 通过 / ⬜ 失败 | |
| 状态是否正确更新 | ⬜ 通过 / ⬜ 失败 | |
| 第二次切换是否成功 | ⬜ 通过 / ⬜ 失败 | |
| 是否有错误提示 | ⬜ 无错误 / ⬜ 有错误 | |

---

## ✅ 测试通过标准

**礼品码生成：**
- ✅ 所有测试项都通过
- ✅ 没有外键约束错误
- ✅ 礼品码成功保存到数据库
- ✅ 礼品码列表正确显示

**支付系统切换：**
- ✅ 所有测试项都通过
- ✅ 没有权限错误
- ✅ 状态正确保存到数据库
- ✅ 开关状态正确更新

---

## 🐛 常见问题

### Q1: 礼品码生成后看不到？

**可能原因：**
- 页面没有刷新
- 数据加载失败

**解决方法：**
1. 手动刷新页面（F5）
2. 检查网络请求是否成功
3. 检查控制台是否有错误

### Q2: 支付系统切换后状态不对？

**可能原因：**
- 前端状态没有同步
- 数据库更新失败

**解决方法：**
1. 刷新页面重新加载状态
2. 检查 Network 标签的响应内容
3. 直接查询数据库验证

### Q3: 仍然有权限错误？

**可能原因：**
- 数据库迁移没有应用
- 函数没有更新

**解决方法：**
1. 检查迁移文件是否存在：
   - `15_decouple_user_architecture.sql`
   - `16_fix_toggle_payment_columns.sql`
2. 手动执行 SQL 测试函数
3. 联系开发人员

---

## 📞 需要帮助？

如果测试失败，请提供以下信息：

1. **失败的测试项**
2. **控制台错误信息**（截图或复制文本）
3. **Network 请求详情**（请求 URL、参数、响应）
4. **测试步骤**（具体操作了什么）

---

**祝测试顺利！** 🎉

**最后更新：** 2025-11-15  
**相关文档：** ✅架构解耦修复完成.md
