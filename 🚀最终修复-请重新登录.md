# ğŸš€ æœ€ç»ˆä¿®å¤å®Œæˆ - è¯·é‡æ–°ç™»å½•æµ‹è¯•

## âœ… æ ¹æœ¬é—®é¢˜å·²è§£å†³

### é—®é¢˜æ ¹æº

**ç”¨æˆ· ID ä¸åŒ¹é…ï¼š**
- `users` è¡¨ä¸­çš„ç”¨æˆ· ID: `18bd1fdc-a571-4ea1-bf58-ae5f844eb480`
- `profiles` è¡¨ä¸­çš„ç”¨æˆ· ID: `ab591cd0-bcff-40f4-bc2f-20ce58cb07eb`
- ä¸¤ä¸ª ID ä¸ä¸€è‡´å¯¼è‡´æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œå¤±è´¥

**ä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ï¼Ÿ**
1. ç”¨æˆ·æ¯æ¬¡ç™»å½•æ—¶ï¼Œ`verify-code-and-login` å‡½æ•°ä¼šåœ¨ `users` è¡¨ä¸­åˆ›å»º/è·å–ç”¨æˆ·
2. ä½† `profiles` è¡¨æ˜¯å•ç‹¬åˆ›å»ºçš„ï¼Œä½¿ç”¨äº†ä¸åŒçš„ ID
3. å½“ç®¡ç†å‘˜æ“ä½œæ—¶ï¼š
   - JWT token åŒ…å« `users` è¡¨çš„ ID
   - ä½† `is_admin_by_id()` æŸ¥è¯¢ `profiles` è¡¨
   - æ‰¾ä¸åˆ°åŒ¹é…çš„ IDï¼Œè¿”å› false
   - æ‰€æœ‰æ“ä½œè¢«æ‹’ç»

---

## ğŸ”§ å·²åº”ç”¨çš„ä¿®å¤

### ä¿®å¤ 1: åŒæ­¥ç”¨æˆ· IDï¼ˆæœ€å…³é”®ï¼‰

**æ›´æ–° `verify-code-and-login` Edge Functionï¼š**
- âœ… ç™»å½•æ—¶æ£€æŸ¥ `profiles` è¡¨
- âœ… å¦‚æœ profile ä¸å­˜åœ¨æˆ– ID ä¸åŒ¹é…ï¼Œè‡ªåŠ¨åŒæ­¥
- âœ… ç¡®ä¿ `users.id` å’Œ `profiles.id` å§‹ç»ˆä¸€è‡´
- âœ… ä¿ç•™åŸæœ‰çš„ roleï¼ˆå¦‚æœæ˜¯ adminï¼Œä¿æŒ adminï¼‰

**ä»£ç é€»è¾‘ï¼š**
```typescript
// è·å–ç”¨æˆ·
let user = await getUserFromUsersTable(email);

// è·å– profile
let profile = await getProfileByEmail(email);

// å¦‚æœ profile ä¸å­˜åœ¨æˆ– ID ä¸åŒ¹é…
if (!profile || profile.id !== user.id) {
  // åŒæ­¥ profileï¼Œä½¿ç”¨ user.id
  profile = await upsertProfile({
    id: user.id,  // ä½¿ç”¨ users è¡¨çš„ ID
    email: user.email,
    role: profile?.role || 'user',  // ä¿ç•™åŸæœ‰è§’è‰²
  });
}
```

### ä¿®å¤ 2: ç¤¼å“ç åˆ›å»ºå­—æ®µå¯é€‰

**æ›´æ–° `gift_codes` è¡¨ï¼š**
- âœ… `created_by` å­—æ®µæ”¹ä¸ºå¯é€‰ï¼ˆå…è®¸ NULLï¼‰
- âœ… é¿å…å¤–é”®çº¦æŸé”™è¯¯

### ä¿®å¤ 3: ç³»ç»Ÿè®¾ç½® RLS

**ç¦ç”¨ `system_settings` è¡¨çš„ RLSï¼š**
- âœ… è®¿é—®æ§åˆ¶é€šè¿‡ `SECURITY DEFINER` å‡½æ•°å¤„ç†
- âœ… é¿å… `auth.uid()` è¿”å› NULL çš„é—®é¢˜

### ä¿®å¤ 4: ç¤¼å“ç é‡å¤æ£€æŸ¥

**æ›´æ–° `generate_gift_code()` å‡½æ•°ï¼š**
- âœ… ç”Ÿæˆå‰æ£€æŸ¥ç æ˜¯å¦å·²å­˜åœ¨
- âœ… å¦‚æœé‡å¤ï¼Œè‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š 10 æ¬¡ï¼‰

---

## ğŸ¯ ç«‹å³æ“ä½œï¼šé‡æ–°ç™»å½•

### æ­¥éª¤ 1: æ¸…é™¤æ—§æ•°æ®

**æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ï¼Œè¿è¡Œï¼š**
```javascript
// æ¸…é™¤æ‰€æœ‰æœ¬åœ°å­˜å‚¨
localStorage.clear();
sessionStorage.clear();

// åˆ·æ–°é¡µé¢
location.reload();
```

### æ­¥éª¤ 2: é‡æ–°ç™»å½•

1. è¾“å…¥é‚®ç®±ï¼š`1062250152@qq.com`
2. ç‚¹å‡»"å‘é€éªŒè¯ç "
3. è¾“å…¥æ”¶åˆ°çš„éªŒè¯ç ï¼ˆæˆ–æŸ¥çœ‹å¼¹çª—ï¼‰
4. ç‚¹å‡»"ç™»å½•"

**é‡è¦ï¼š** è¿™æ¬¡ç™»å½•ä¼šè‡ªåŠ¨åŒæ­¥æ‚¨çš„ç”¨æˆ· ID å’Œ profile IDï¼

### æ­¥éª¤ 3: éªŒè¯ç™»å½•æˆåŠŸ

**æ‰“å¼€æ§åˆ¶å°ï¼Œè¿è¡Œï¼š**
```javascript
// æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯
const user = JSON.parse(localStorage.getItem('user'));
console.log('ç”¨æˆ· ID:', user.id);
console.log('é‚®ç®±:', user.email);
console.log('è§’è‰²:', user.role);
```

**é¢„æœŸè¾“å‡ºï¼š**
```
ç”¨æˆ· ID: 18bd1fdc-a571-4ea1-bf58-ae5f844eb480
é‚®ç®±: 1062250152@qq.com
è§’è‰²: admin
```

### æ­¥éª¤ 4: æµ‹è¯•ç¤¼å“ç ç”Ÿæˆ

1. è¿›å…¥ç®¡ç†å‘˜åå°
2. ç‚¹å‡»"ç¤¼å“ç ç®¡ç†"
3. ç‚¹å‡»"ç”Ÿæˆç¤¼å“ç "

**é¢„æœŸç»“æœï¼š**
```javascript
ğŸ generateGiftCode: å¼€å§‹ç”Ÿæˆ
âœ… generateGiftCode: ç”Ÿæˆéšæœºç  "A3K7N9P2"
ğŸ generateGiftCode: æ’å…¥æ•°æ®åº“
âœ… generateGiftCode: æˆåŠŸ
```

**é¡µé¢æ˜¾ç¤ºï¼š**
- âœ… Toast æç¤º"ç¤¼å“ç ç”ŸæˆæˆåŠŸ"
- âœ… åˆ—è¡¨ä¸­å‡ºç°æ–°çš„ç¤¼å“ç 
- âœ… æ²¡æœ‰ä»»ä½•é”™è¯¯

### æ­¥éª¤ 5: æµ‹è¯•æ”¯ä»˜ç³»ç»Ÿåˆ‡æ¢

1. åœ¨ç®¡ç†å‘˜åå°
2. æ‰¾åˆ°"æ”¯ä»˜ç³»ç»Ÿ"å¼€å…³
3. ç‚¹å‡»åˆ‡æ¢

**é¢„æœŸç»“æœï¼š**
```javascript
ğŸ”§ togglePaymentSystem: è°ƒç”¨ RPC {enabled: true, user_id: "18bd1fdc-a571-4ea1-bf58-ae5f844eb480"}
âœ… togglePaymentSystem: æˆåŠŸ {success: true, enabled: true}
```

**é¡µé¢æ˜¾ç¤ºï¼š**
- âœ… å¼€å…³çŠ¶æ€ç«‹å³æ”¹å˜
- âœ… Toast æç¤º"æ”¯ä»˜ç³»ç»Ÿå·²å¯ç”¨/ç¦ç”¨"
- âœ… æ²¡æœ‰"Unauthorized"é”™è¯¯

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### é—®é¢˜ 1: ç¤¼å“ç ç”Ÿæˆå¤±è´¥

**ä¹‹å‰çš„é”™è¯¯ï¼š**
```
Error: insert or update on table "gift_codes" violates foreign key constraint "gift_codes_created_by_fkey"
Details: Key (created_by)=(18bd1fdc-a571-4ea1-bf58-ae5f844eb480) is not present in table "profiles".
```

**åŸå› ï¼š**
- JWT token ä¸­çš„ user.id æ˜¯ `18bd1fdc-a571-4ea1-bf58-ae5f844eb480`
- ä½† profiles è¡¨ä¸­åªæœ‰ `ab591cd0-bcff-40f4-bc2f-20ce58cb07eb`
- å¤–é”®çº¦æŸæ£€æŸ¥å¤±è´¥

**ä¿®å¤ï¼š**
- âœ… ç™»å½•æ—¶è‡ªåŠ¨åŒæ­¥ profile ID
- âœ… `created_by` å­—æ®µæ”¹ä¸ºå¯é€‰

### é—®é¢˜ 2: æ”¯ä»˜ç³»ç»Ÿåˆ‡æ¢å¤±è´¥

**ä¹‹å‰çš„é”™è¯¯ï¼š**
```
Error: Unauthorized: Only admins can toggle payment system
Code: P0001
```

**åŸå› ï¼š**
- `toggle_payment_system` å‡½æ•°è°ƒç”¨ `is_admin_by_id(user_id)`
- `is_admin_by_id` æŸ¥è¯¢ `profiles` è¡¨
- æ‰¾ä¸åˆ°åŒ¹é…çš„ user_idï¼Œè¿”å› false
- å‡½æ•°æŠ›å‡º"Unauthorized"é”™è¯¯

**ä¿®å¤ï¼š**
- âœ… ç™»å½•æ—¶è‡ªåŠ¨åŒæ­¥ profile ID
- âœ… `is_admin_by_id` ç°åœ¨èƒ½æ‰¾åˆ°æ­£ç¡®çš„ profile

---

## ğŸ” æ•°æ®åº“çŠ¶æ€éªŒè¯

### æ£€æŸ¥ç”¨æˆ·åŒæ­¥

**ç™»å½• Supabase Dashboardï¼Œè¿è¡Œï¼š**
```sql
-- æ£€æŸ¥ users è¡¨
SELECT id, email, created_at 
FROM users 
WHERE email = '1062250152@qq.com';

-- æ£€æŸ¥ profiles è¡¨
SELECT id, email, role, created_at 
FROM profiles 
WHERE email = '1062250152@qq.com';

-- ä¸¤ä¸ªè¡¨çš„ ID åº”è¯¥ç›¸åŒï¼
```

**é¢„æœŸç»“æœï¼š**
```
users.id = profiles.id = 18bd1fdc-a571-4ea1-bf58-ae5f844eb480
```

### æ£€æŸ¥ç®¡ç†å‘˜æƒé™

```sql
-- æµ‹è¯• is_admin_by_id å‡½æ•°
SELECT is_admin_by_id('18bd1fdc-a571-4ea1-bf58-ae5f844eb480'::uuid);
```

**é¢„æœŸç»“æœï¼š**
```
is_admin_by_id: true
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: é‡æ–°ç™»å½•åä»ç„¶å¤±è´¥ï¼Ÿ

**A:** è¯·ç¡®ä¿ï¼š
1. âœ… å·²æ¸…é™¤ localStorageï¼ˆè¿è¡Œ `localStorage.clear()`ï¼‰
2. âœ… å·²åˆ·æ–°é¡µé¢ï¼ˆCtrl+F5ï¼‰
3. âœ… ä½¿ç”¨æ­£ç¡®çš„é‚®ç®±ï¼ˆ1062250152@qq.comï¼‰
4. âœ… æŸ¥çœ‹æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

### Q2: ç¤¼å“ç ç”Ÿæˆä»ç„¶å¤±è´¥ï¼Ÿ

**A:** æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ï¼š

**å¦‚æœçœ‹åˆ° 409 é”™è¯¯ï¼š**
- è¯´æ˜ç”Ÿæˆäº†é‡å¤çš„ç 
- è¿™ç§æƒ…å†µæå°‘ï¼ˆæ¦‚ç‡ 1/10^10ï¼‰
- é‡è¯•å³å¯

**å¦‚æœçœ‹åˆ° 23503 é”™è¯¯ï¼ˆå¤–é”®çº¦æŸï¼‰ï¼š**
- è¯´æ˜ profile åŒæ­¥å¤±è´¥
- é‡æ–°ç™»å½•
- æˆ–æ‰‹åŠ¨è¿è¡Œï¼š
  ```sql
  SELECT ensure_profile_exists(
    '18bd1fdc-a571-4ea1-bf58-ae5f844eb480'::uuid,
    '1062250152@qq.com',
    'admin'::user_role
  );
  ```

### Q3: æ”¯ä»˜ç³»ç»Ÿåˆ‡æ¢ä»ç„¶å¤±è´¥ï¼Ÿ

**A:** æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ï¼š

**å¦‚æœçœ‹åˆ°"Unauthorized"ï¼š**
- è¯´æ˜ `is_admin_by_id` è¿”å› false
- æ£€æŸ¥ profiles è¡¨æ˜¯å¦æœ‰æ‚¨çš„è®°å½•
- é‡æ–°ç™»å½•

**å¦‚æœçœ‹åˆ° 400 é”™è¯¯ï¼š**
- æŸ¥çœ‹å®Œæ•´é”™è¯¯æ¶ˆæ¯
- å¯èƒ½æ˜¯å…¶ä»–åŸå› 

---

## ğŸ“ å·²åº”ç”¨çš„æ•°æ®åº“è¿ç§»

1. âœ… `10_disable_rls_for_custom_auth.sql` - ç¦ç”¨ç¤¼å“ç è¡¨ RLS
2. âœ… `11_fix_payment_toggle.sql` - ä¿®å¤æ”¯ä»˜åˆ‡æ¢ JSON æ ¼å¼
3. âœ… `12_fix_gift_code_generation.sql` - ä¿®å¤ç¤¼å“ç é‡å¤æ£€æŸ¥
4. âœ… `13_fix_system_settings_rls.sql` - ç¦ç”¨ç³»ç»Ÿè®¾ç½®è¡¨ RLS
5. âœ… `14_ensure_user_profiles_exist.sql` - ç¡®ä¿ç”¨æˆ· profile å­˜åœ¨

### å·²æ›´æ–°çš„ Edge Functions

1. âœ… `send-verification-code` - åªç»™ç®¡ç†å‘˜é‚®ç®±å‘é€çœŸå®é‚®ä»¶
2. âœ… `verify-code-and-login` - è‡ªåŠ¨åŒæ­¥ç”¨æˆ· ID å’Œ profile ID

---

## âœ… æˆåŠŸæ ‡å¿—

### ç™»å½•æˆåŠŸ

- âœ… æ§åˆ¶å°æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
- âœ… ç”¨æˆ· ID å’Œ profile ID ä¸€è‡´
- âœ… è§’è‰²æ˜¾ç¤ºä¸º "admin"
- âœ… èƒ½çœ‹åˆ°"ç®¡ç†å‘˜åå°"æŒ‰é’®

### ç¤¼å“ç ç”ŸæˆæˆåŠŸ

- âœ… æ§åˆ¶å°æ˜¾ç¤º `âœ… generateGiftCode: æˆåŠŸ`
- âœ… Toast æç¤º"ç¤¼å“ç ç”ŸæˆæˆåŠŸ"
- âœ… åˆ—è¡¨ä¸­å‡ºç°æ–°çš„ç¤¼å“ç 
- âœ… æ²¡æœ‰ 409 æˆ– 23503 é”™è¯¯

### æ”¯ä»˜ç³»ç»Ÿåˆ‡æ¢æˆåŠŸ

- âœ… æ§åˆ¶å°æ˜¾ç¤º `âœ… togglePaymentSystem: æˆåŠŸ`
- âœ… å¼€å…³çŠ¶æ€ç«‹å³æ”¹å˜
- âœ… Toast æç¤º"æ”¯ä»˜ç³»ç»Ÿå·²å¯ç”¨/ç¦ç”¨"
- âœ… æ²¡æœ‰"Unauthorized"é”™è¯¯

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¿®å¤

**é—®é¢˜ï¼š** ç”¨æˆ· ID ä¸åŒ¹é…å¯¼è‡´æ‰€æœ‰ç®¡ç†å‘˜æ“ä½œå¤±è´¥

**è§£å†³ï¼š** ç™»å½•æ—¶è‡ªåŠ¨åŒæ­¥ `users.id` å’Œ `profiles.id`

### å…¶ä»–ä¿®å¤

1. âœ… ç¤¼å“ç é‡å¤æ£€æŸ¥
2. âœ… ç³»ç»Ÿè®¾ç½® RLS ç¦ç”¨
3. âœ… é‚®ä»¶å‘é€é€»è¾‘ä¼˜åŒ–
4. âœ… è¯¦ç»†é”™è¯¯æ—¥å¿—

### ä¸‹ä¸€æ­¥

1. **ç«‹å³é‡æ–°ç™»å½•**ï¼ˆæ¸…é™¤ localStorageï¼‰
2. **æµ‹è¯•ç¤¼å“ç ç”Ÿæˆ**
3. **æµ‹è¯•æ”¯ä»˜ç³»ç»Ÿåˆ‡æ¢**
4. **åé¦ˆæµ‹è¯•ç»“æœ**

---

**ç°åœ¨å°±é‡æ–°ç™»å½•æµ‹è¯•å§ï¼** ğŸš€

**æœ€åæ›´æ–°ï¼š** 2025-11-10  
**Git æäº¤ï¼š** b0be104  
**è¿ç§»æ–‡ä»¶ï¼š** 10, 11, 12, 13, 14  
**Edge Functionsï¼š** send-verification-code (v6), verify-code-and-login (v5)
