<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†å‘˜æƒé™æ£€æŸ¥å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
      border-left: 4px solid #4CAF50;
    }
    .error {
      border-left-color: #f44336;
    }
    .warning {
      border-left-color: #ff9800;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    pre {
      background: #272822;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
    }
    .status {
      font-size: 24px;
      font-weight: bold;
      margin: 20px 0;
    }
    .success {
      color: #4CAF50;
    }
    .fail {
      color: #f44336;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ç®¡ç†å‘˜æƒé™æ£€æŸ¥å·¥å…·</h1>
    
    <div class="section">
      <h3>å½“å‰çŠ¶æ€</h3>
      <div id="status" class="status">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="section">
      <h3>Token ä¿¡æ¯</h3>
      <pre id="tokenInfo">åŠ è½½ä¸­...</pre>
    </div>

    <div class="section">
      <h3>ç”¨æˆ·ä¿¡æ¯</h3>
      <pre id="userInfo">åŠ è½½ä¸­...</pre>
    </div>

    <div class="section">
      <h3>æ•°æ®åº“è§’è‰²</h3>
      <pre id="dbRole">åŠ è½½ä¸­...</pre>
    </div>

    <div class="section">
      <h3>æ“ä½œ</h3>
      <button onclick="checkAdmin()">ğŸ”„ é‡æ–°æ£€æŸ¥</button>
      <button onclick="clearAndReload()" class="danger">ğŸ—‘ï¸ æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•</button>
    </div>

    <div class="section warning">
      <h3>âš ï¸ å¦‚æœæ‚¨çœ‹ä¸åˆ°ç®¡ç†å‘˜æŒ‰é’®</h3>
      <p><strong>åŸå› </strong>: æ‚¨å½“å‰ä½¿ç”¨çš„æ˜¯æ—§çš„ç™»å½• Tokenï¼Œä¸åŒ…å«è§’è‰²ä¿¡æ¯ã€‚</p>
      <p><strong>è§£å†³æ–¹æ¡ˆ</strong>: ç‚¹å‡»ä¸Šæ–¹çš„"æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•"æŒ‰é’®ï¼Œç„¶åé‡æ–°ç™»å½•ã€‚</p>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://ahgnspudsmrvsqcinxcj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFoZ25zcHVkc21ydnNxY2lueGNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3NjY3OTksImV4cCI6MjA3ODM0Mjc5OX0.KZkaD_GdgMXe_e7Eo0i6yf23-YyADnne3Biq9iizuW0';

    async function checkAdmin() {
      const token = localStorage.getItem('auth_token');
      
      // æ˜¾ç¤º Token ä¿¡æ¯
      if (!token) {
        document.getElementById('tokenInfo').textContent = 'âŒ æœªæ‰¾åˆ° Token\nè¯·å…ˆç™»å½•ç³»ç»Ÿ';
        document.getElementById('status').innerHTML = '<span class="fail">âŒ æœªç™»å½•</span>';
        return;
      }

      document.getElementById('tokenInfo').textContent = `âœ… Token å­˜åœ¨\né•¿åº¦: ${token.length} å­—ç¬¦\nå‰20å­—ç¬¦: ${token.substring(0, 20)}...`;

      // éªŒè¯ Token å¹¶è·å–ç”¨æˆ·ä¿¡æ¯
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/verify-token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            'apikey': SUPABASE_ANON_KEY,
          },
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        document.getElementById('userInfo').textContent = JSON.stringify(data, null, 2);

        // æ£€æŸ¥è§’è‰²
        if (data.valid && data.user) {
          const userRole = data.user.role;
          
          if (userRole === 'admin') {
            document.getElementById('status').innerHTML = '<span class="success">âœ… æ‚¨æ˜¯ç®¡ç†å‘˜ï¼</span>';
            document.getElementById('dbRole').textContent = `âœ… è§’è‰²: ${userRole}\n\næ­å–œï¼æ‚¨çš„è´¦å·å·²æ­£ç¡®é…ç½®ä¸ºç®¡ç†å‘˜ã€‚\nå¦‚æœé¦–é¡µçœ‹ä¸åˆ°ç®¡ç†å‘˜æŒ‰é’®ï¼Œè¯·åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+Rï¼‰ã€‚`;
          } else if (userRole) {
            document.getElementById('status').innerHTML = '<span class="fail">âŒ æ‚¨ä¸æ˜¯ç®¡ç†å‘˜</span>';
            document.getElementById('dbRole').textContent = `âš ï¸ è§’è‰²: ${userRole}\n\næ‚¨çš„è´¦å·ä¸æ˜¯ç®¡ç†å‘˜è§’è‰²ã€‚`;
          } else {
            document.getElementById('status').innerHTML = '<span class="fail">âš ï¸ Token ä¸­æ²¡æœ‰è§’è‰²ä¿¡æ¯</span>';
            document.getElementById('dbRole').textContent = `âš ï¸ Token ä¸­æ²¡æœ‰ role å­—æ®µ\n\nè¿™æ˜¯å› ä¸ºæ‚¨ä½¿ç”¨çš„æ˜¯æ—§çš„ Tokenï¼ˆåœ¨è§’è‰²åŠŸèƒ½æ·»åŠ ä¹‹å‰ç”Ÿæˆçš„ï¼‰ã€‚\n\nè§£å†³æ–¹æ¡ˆï¼š\n1. ç‚¹å‡»ä¸‹æ–¹çš„"æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•"æŒ‰é’®\n2. é‡æ–°ç™»å½•ç³»ç»Ÿ\n3. æ–°çš„ Token å°†åŒ…å«è§’è‰²ä¿¡æ¯`;
          }
        } else {
          document.getElementById('status').innerHTML = '<span class="fail">âŒ Token æ— æ•ˆ</span>';
          document.getElementById('dbRole').textContent = 'âŒ Token éªŒè¯å¤±è´¥';
        }

      } catch (error) {
        console.error('æ£€æŸ¥å¤±è´¥:', error);
        document.getElementById('userInfo').textContent = `âŒ é”™è¯¯: ${error.message}`;
        document.getElementById('status').innerHTML = '<span class="fail">âŒ æ£€æŸ¥å¤±è´¥</span>';
        document.getElementById('dbRole').textContent = `âŒ æ— æ³•éªŒè¯è§’è‰²\né”™è¯¯: ${error.message}`;
      }
    }

    function clearAndReload() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ç™»å½•å—ï¼Ÿ\n\nè¿™å°†ï¼š\n1. æ¸…é™¤å½“å‰ç™»å½•çŠ¶æ€\n2. è·³è½¬åˆ°ç™»å½•é¡µé¢\n3. æ‚¨éœ€è¦é‡æ–°è¾“å…¥é‚®ç®±å’ŒéªŒè¯ç ')) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user');
        localStorage.removeItem('currentTestId');
        alert('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼\n\nç°åœ¨å°†è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œè¯·é‡æ–°ç™»å½•ã€‚');
        window.location.href = '/login';
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', checkAdmin);
  </script>
</body>
</html>
