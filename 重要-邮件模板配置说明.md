# ⚠️ 重要：邮件模板配置说明

## 🔍 问题诊断

如果您修改了模板后仍然收到链接而不是验证码，可能是以下原因：

### 1. 修改了错误的模板 ⚠️

Supabase 有**两个不同的邮件模板**：

| 模板名称 | 用途 | 内容 |
|---------|------|------|
| **Magic Link** | 魔法链接登录 | 发送可点击的链接 |
| **Confirm signup** | OTP 验证码登录 | 发送6位数字验证码 |

**❌ 错误做法**：修改 "Magic Link" 模板  
**✅ 正确做法**：修改 "Confirm signup" 模板

---

## 🎯 正确配置步骤

### 步骤1: 访问正确的模板页面

1. 登录 Supabase Dashboard
2. 访问：https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/auth/templates
3. **重要**：找到 **"Confirm signup"** 模板（不是 "Magic Link"）

### 步骤2: 确认当前模板内容

在修改之前，先查看当前的模板内容。默认的 "Confirm signup" 模板可能包含：

```html
<h2>Confirm your signup</h2>

<p>Follow this link to confirm your user:</p>
<p><a href="{{ .ConfirmationURL }}">Confirm your mail</a></p>
```

或者：

```html
<h2>Confirm your signup</h2>

<p>Enter this code: {{ .Token }}</p>
```

### 步骤3: 替换为新模板

**完全删除**原有内容，然后粘贴以下新模板：

```html
<h2>确认您的邮箱</h2>

<p>您好！</p>

<p>感谢您使用人格特质投资策略评估系统。</p>

<p>您的验证码是：</p>

<h1 style="font-size: 32px; font-weight: bold; color: #1DB954; letter-spacing: 5px; margin: 20px 0;">{{ .Token }}</h1>

<p>此验证码将在 <strong>5分钟</strong> 后过期。</p>

<p>如果您没有请求此验证码，请忽略此邮件。</p>

<hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

<p style="color: #666; font-size: 12px;">
  这是一封自动发送的邮件，请勿回复。<br>
  人格特质投资策略评估系统
</p>
```

### 步骤4: 保存并验证

1. 点击 **"Save"** 按钮
2. 确认看到保存成功的提示
3. **重要**：等待 2-3 分钟让配置生效

---

## 🔍 如何确认修改了正确的模板

### 方法1: 检查模板列表

在 Email Templates 页面，您应该看到：

```
📧 Email Templates

├── Confirm signup          ← 修改这个！
├── Invite user
├── Magic Link             ← 不要修改这个
├── Change Email Address
└── Reset Password
```

### 方法2: 检查模板标题

点击进入模板编辑页面后，页面顶部应该显示：

```
Email Templates > Confirm signup
```

如果显示的是 "Magic Link"，说明您打开了错误的模板。

---

## 🧪 测试验证

### 完整测试流程

1. **清除浏览器缓存**
   - Chrome: Ctrl+Shift+Delete
   - 选择"缓存的图片和文件"
   - 点击"清除数据"

2. **等待配置生效**
   - 保存模板后等待 2-3 分钟

3. **重新测试**
   - 访问登录页面
   - 输入邮箱：`1062250152@qq.com`
   - 点击"发送验证码"

4. **检查邮件**
   - 查看收件箱（和垃圾邮件箱）
   - 确认邮件主题是："Confirm your signup"
   - 确认邮件内容包含：6位数字验证码

### 预期的邮件内容

**✅ 正确的邮件**（包含数字验证码）：
```
确认您的邮箱

您好！

感谢您使用人格特质投资策略评估系统。

您的验证码是：

123456

此验证码将在 5分钟 后过期。
```

**❌ 错误的邮件**（包含链接）：
```
Confirm your signup

Follow this link to confirm your user:
[Confirm your mail]
```

---

## 🔧 高级诊断

### 检查 Supabase Auth 日志

1. 访问：https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/logs/auth-logs
2. 查找最近的登录尝试
3. 检查发送的邮件类型

### 检查邮件模板变量

确认模板中使用的是 `{{ .Token }}` 而不是 `{{ .ConfirmationURL }}`：

**✅ 正确**：
```html
<h1>{{ .Token }}</h1>
```

**❌ 错误**：
```html
<a href="{{ .ConfirmationURL }}">Confirm</a>
```

---

## 📸 截图指南

如果问题仍然存在，请检查以下内容：

### 1. 确认模板名称
在 Supabase Dashboard 的 Email Templates 页面，应该看到：
- ✅ "Confirm signup" - 这是您需要修改的模板

### 2. 确认模板内容
打开 "Confirm signup" 模板后，应该看到：
- ✅ 包含 `{{ .Token }}` 变量
- ❌ 不包含 `{{ .ConfirmationURL }}` 变量

### 3. 确认保存成功
保存后应该看到：
- ✅ "Template saved successfully" 或类似的成功提示

---

## 🔄 如果问题仍然存在

### 方案1: 重置模板

1. 在 Supabase Dashboard 中找到 "Confirm signup" 模板
2. 点击 "Reset to default"（如果有这个选项）
3. 然后重新粘贴新模板内容
4. 保存

### 方案2: 检查 Supabase 项目设置

1. 访问：https://supabase.com/dashboard/project/zrfnnerdaijcmhlemqld/settings/auth
2. 确认 "Enable email confirmations" 已启用
3. 确认 "Secure email change" 设置正确

### 方案3: 联系支持

如果以上方法都不起作用，可能需要：
1. 检查 Supabase 项目的配额和限制
2. 查看 Supabase 服务状态
3. 联系 Supabase 技术支持

---

## 📋 配置检查清单

请逐项确认：

- [ ] 访问了正确的 Supabase 项目（zrfnnerdaijcmhlemqld）
- [ ] 进入了 "Email Templates" 设置页面
- [ ] 找到了 **"Confirm signup"** 模板（不是 "Magic Link"）
- [ ] 点击进入编辑页面
- [ ] 页面顶部显示 "Email Templates > Confirm signup"
- [ ] 完全删除了原有模板内容
- [ ] 粘贴了新的模板内容
- [ ] 确认模板中包含 `{{ .Token }}` 变量
- [ ] 点击了 "Save" 按钮
- [ ] 看到了保存成功的提示
- [ ] 等待了 2-3 分钟
- [ ] 清除了浏览器缓存
- [ ] 重新测试发送验证码
- [ ] 检查了邮箱（包括垃圾邮件箱）

---

## 🎯 关键要点

### ⚠️ 最重要的三点

1. **修改正确的模板**
   - ✅ "Confirm signup" 模板
   - ❌ 不是 "Magic Link" 模板

2. **使用正确的变量**
   - ✅ `{{ .Token }}` - 显示验证码
   - ❌ `{{ .ConfirmationURL }}` - 显示链接

3. **等待配置生效**
   - 保存后等待 2-3 分钟
   - 清除浏览器缓存
   - 重新测试

---

## 📞 需要帮助？

如果您已经按照上述步骤操作，但仍然收到链接而不是验证码，请提供以下信息：

1. 您修改的是哪个模板？（模板名称）
2. 模板内容中是否包含 `{{ .Token }}`？
3. 保存后是否看到成功提示？
4. 等待了多长时间后测试？
5. 收到的邮件主题是什么？
6. 邮件内容是什么样的？

---

**最后更新**: 2025-01-10  
**重要性**: ⭐⭐⭐⭐⭐（必须正确配置）

**请仔细检查每一步，确保修改了正确的模板！** 🎯
